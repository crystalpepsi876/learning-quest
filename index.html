<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Learning Quest">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0F0A2E">
  <title>Learning Quest</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0F0A2E;--bg2:#1A1145;--teal:#4ECDC4;--green:#06D6A0;--yellow:#FFE66D;--orange:#F97316;--red:#FF6B6B;--purple:#A78BFA;--violet:#7C3AED;--muted:rgba(255,255,255,.6);--dim:rgba(255,255,255,.3);--glass:rgba(255,255,255,.06);--gb:rgba(255,255,255,.12);--gold:#FFD700;--coin:#FFC832;}
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{min-height:100vh;min-height:100dvh;overflow-x:hidden}
    body{font-family:'Nunito','Segoe UI',sans-serif;background:linear-gradient(145deg,var(--bg) 0%,var(--bg2) 40%,#0D1B3E 70%,#071428 100%);color:#fff;display:flex;justify-content:center;align-items:flex-start;padding:16px;padding-top:max(env(safe-area-inset-top),16px);padding-bottom:max(env(safe-area-inset-bottom),16px)}
    #app{width:100%;max-width:520px}
    .screen{display:none;animation:fadeIn .3s ease}
    .screen.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    .card{background:var(--glass);border:1px solid var(--gb);border-radius:20px;padding:24px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:14px;cursor:pointer;font-family:inherit;font-weight:800;font-size:1rem;padding:14px 24px;transition:all .18s;width:100%;margin-top:10px}
    .btn:active{transform:scale(.96)}
    .btn-primary{background:linear-gradient(135deg,var(--teal),var(--violet));color:#fff}
    .btn-secondary{background:var(--glass);border:1px solid var(--gb);color:#fff}
    .btn-green{background:linear-gradient(135deg,var(--green),var(--teal));color:#fff}
    .btn-sm{padding:10px 18px;font-size:.85rem;border-radius:11px;margin-top:6px}
    .inp{width:100%;background:var(--glass);border:2px solid var(--gb);border-radius:14px;padding:14px 18px;color:#fff;font-family:inherit;font-size:1.1rem;font-weight:700;outline:none;transition:border .2s}
    .inp:focus{border-color:var(--teal)}
    .inp::placeholder{color:var(--dim)}
    .sec-title{font-size:1.4rem;font-weight:900;text-align:center;margin-bottom:18px}
    .back-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.9rem;font-family:inherit;padding:8px 0;margin-bottom:16px;display:flex;align-items:center;gap:6px}
    .coin-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,200,50,.15);border:1px solid rgba(255,200,50,.3);border-radius:20px;padding:5px 12px;font-weight:800;font-size:.95rem;color:var(--coin)}

    /* WELCOME */
    .player-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
    .player-chip{display:flex;align-items:center;justify-content:space-between;background:var(--glass);border:1px solid var(--gb);border-radius:14px;padding:12px 16px;cursor:pointer;transition:all .2s}
    .player-chip:hover{border-color:var(--teal)}
    .player-info{display:flex;align-items:center;gap:12px}
    .p-avatar-mini{width:36px;height:36px;border-radius:50%;overflow:hidden}
    .p-name{font-weight:800}
    .p-meta{font-size:.8rem;color:var(--muted)}
    .p-coins{color:var(--coin);font-weight:800;font-size:.9rem}

    /* AVATAR TYPE */
    .type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:20px 0}
    .type-card{background:var(--glass);border:2px solid var(--gb);border-radius:18px;padding:16px 8px;text-align:center;cursor:pointer;transition:all .2s}
    .type-card:hover,.type-card.sel{border-color:var(--teal);background:rgba(78,205,196,.1)}
    .type-icon{font-size:2.5rem;margin-bottom:8px}
    .type-name{font-weight:800;font-size:.95rem}

    /* SKIN/HAIR */
    .skin-grid{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin:20px 0}
    .skin-sw{width:56px;height:56px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .2s}
    .skin-sw.sel{border-color:var(--teal);box-shadow:0 0 0 3px rgba(78,205,196,.4)}
    .hair-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:16px 0}
    .hair-sw{height:36px;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s}
    .hair-sw.sel{border-color:var(--teal)}

    /* HUB */
    .hub-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .hub-welcome{font-size:1.1rem;font-weight:700}
    .hub-welcome span{color:var(--teal)}
    .hub-av-sec{display:flex;gap:20px;align-items:center;margin-bottom:24px}
    .hub-av-prev{width:110px;height:110px;border-radius:20px;overflow:hidden;background:rgba(255,255,255,.05);border:2px solid var(--gb);flex-shrink:0;display:flex;align-items:center;justify-content:center}
    .hub-stats{flex:1}
    .stat-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--gb)}
    .stat-row:last-child{border-bottom:none}
    .stat-lbl{color:var(--muted);font-size:.85rem}
    .stat-val{font-weight:800;font-size:.95rem}
    .hub-nav{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hub-btn{display:flex;flex-direction:column;align-items:center;gap:8px;background:var(--glass);border:1px solid var(--gb);border-radius:18px;padding:18px 10px;cursor:pointer;transition:all .2s;font-family:inherit;color:#fff}
    .hub-btn:hover{background:rgba(255,255,255,.1)}
    .hub-btn .ni{font-size:1.8rem}
    .hub-btn .nl{font-weight:800;font-size:.9rem}
    .hub-btn.play-btn{background:linear-gradient(135deg,rgba(6,214,160,.2),rgba(78,205,196,.2));border:1px solid rgba(78,205,196,.3);grid-column:1/-1}
    .hub-btn.play-btn .nl{font-size:1.1rem}

    /* SUBJECT - 5 game grid */
    .sub-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
    .sub-card{background:var(--glass);border:2px solid var(--gb);border-radius:18px;padding:18px 12px;text-align:center;cursor:pointer;transition:all .2s;font-family:inherit;color:#fff}
    .sub-card:hover{transform:scale(1.03)}
    .sub-card .si{font-size:2.2rem;margin-bottom:10px}
    .sub-card .sl{font-weight:900;font-size:1rem;margin-bottom:4px}
    .sub-card .sd{color:var(--muted);font-size:.75rem}
    .sub-card.math{border:2px solid rgba(78,205,196,.4);background:linear-gradient(135deg,rgba(78,205,196,.12),rgba(78,205,196,.03))}
    .sub-card.spelling{border:2px solid rgba(167,139,250,.4);background:linear-gradient(135deg,rgba(167,139,250,.12),rgba(167,139,250,.03))}
    .sub-card.geography{border:2px solid rgba(6,214,160,.4);background:linear-gradient(135deg,rgba(6,214,160,.12),rgba(6,214,160,.03))}
    .sub-card.scramble{border:2px solid rgba(249,115,22,.4);background:linear-gradient(135deg,rgba(249,115,22,.12),rgba(249,115,22,.03))}
    .sub-card.mix{grid-column:1/-1;border:2px solid rgba(255,215,0,.5);background:linear-gradient(135deg,rgba(255,215,0,.12),rgba(255,107,107,.08))}
    .sub-card.mix .sl{color:var(--yellow);font-size:1.1rem}

    /* VOICE/GRADE */
    .voice-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0}
    .voice-card{background:var(--glass);border:2px solid var(--gb);border-radius:16px;padding:16px;text-align:center;cursor:pointer;transition:all .2s}
    .voice-card:hover,.voice-card.sel{border-color:var(--teal);background:rgba(78,205,196,.08)}
    .vi{font-size:1.8rem;margin-bottom:8px}
    .vn{font-weight:800;font-size:.9rem}
    .vd{color:var(--muted);font-size:.75rem;margin-top:2px}
    .grade-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:16px 0}
    .grade-card{background:var(--glass);border:2px solid var(--gb);border-radius:14px;padding:16px 8px;text-align:center;cursor:pointer;transition:all .2s;font-family:inherit;color:#fff}
    .grade-card:hover{border-color:var(--teal)}

    /* PLAY */
    .play-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px}
    .play-info{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .badge{display:inline-block;background:var(--glass);border:1px solid var(--gb);border-radius:20px;padding:5px 12px;font-size:.8rem;font-weight:700}
    .badge.streak{color:var(--orange)}
    .prog-bar{height:8px;background:var(--glass);border-radius:8px;overflow:hidden;margin-bottom:20px}
    .prog-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--green));border-radius:8px;transition:width .4s ease}
    .q-card{background:var(--glass);border:1px solid var(--gb);border-radius:20px;padding:28px 20px;text-align:center;margin-bottom:16px;min-height:130px;display:flex;flex-direction:column;justify-content:center}
    .q-lbl{color:var(--muted);font-size:.85rem;margin-bottom:12px}
    .q-text{font-size:2rem;font-weight:900;line-height:1.2}
    .q-sub{color:var(--muted);font-size:.9rem;margin-top:8px}
    /* MC */
    .mc-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
    .mc-btn{background:var(--glass);border:2px solid var(--gb);border-radius:14px;padding:14px 10px;color:#fff;font-family:inherit;font-weight:700;font-size:.9rem;cursor:pointer;transition:all .2s;text-align:center;line-height:1.3}
    .mc-btn:hover{border-color:var(--teal)}
    .mc-btn.correct-ans{background:rgba(6,214,160,.2);border-color:var(--green);color:var(--green)}
    .mc-btn.wrong-ans{background:rgba(255,107,107,.15);border-color:var(--red);color:var(--red)}
    /* SCRAMBLE */
    .scr-tiles{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:12px 0}
    .scr-tile{width:44px;height:44px;background:rgba(249,115,22,.15);border:2px solid rgba(249,115,22,.4);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:900;color:var(--orange);cursor:pointer;transition:all .15s;user-select:none}
    .scr-tile:hover{background:rgba(249,115,22,.3);transform:scale(1.08)}
    .scr-tile.used{opacity:.25;cursor:default;transform:none}
    .ans-tiles{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;min-height:52px;padding:8px;background:rgba(255,255,255,.03);border:2px dashed rgba(255,255,255,.15);border-radius:14px;margin:10px 0}
    .ans-tile{width:44px;height:44px;background:rgba(78,205,196,.15);border:2px solid rgba(78,205,196,.4);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:900;color:var(--teal);cursor:pointer;transition:all .15s}
    .ans-tile:hover{background:rgba(78,205,196,.3)}
    /* TEXT ANSWER */
    .ans-area{display:flex;gap:10px;margin-bottom:16px}
    .ans-area .inp{flex:1}
    .ans-area .btn{width:auto;flex-shrink:0;margin:0;padding:14px 20px}
    /* FEEDBACK */
    .feedback{border-radius:14px;padding:12px 16px;text-align:center;font-weight:700;margin-bottom:12px;display:none}
    .feedback.correct{background:rgba(6,214,160,.15);border:1px solid rgba(6,214,160,.3);color:var(--green)}
    .feedback.wrong{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.25);color:var(--red)}
    .hint-txt{color:var(--muted);font-size:.9rem;text-align:center;margin-bottom:10px;display:none}
    /* MIX TAG */
    .mix-tag{display:none;margin-bottom:12px;text-align:center}
    .mix-pill{display:inline-flex;align-items:center;gap:6px;border-radius:20px;padding:5px 14px;font-size:.85rem;font-weight:800}
    /* COIN POP */
    .coin-pop{position:fixed;pointer-events:none;font-size:1.1rem;font-weight:900;color:var(--coin);text-shadow:0 2px 8px rgba(0,0,0,.5);animation:coinUp 1.5s ease-out forwards;z-index:999}
    @keyframes coinUp{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(1.3)}}

    /* GOAT */
    #screen-goat{text-align:center;padding:20px 0}
    .goat-emoji{font-size:5rem;animation:goatB .6s ease infinite alternate;display:block;margin-bottom:12px}
    @keyframes goatB{from{transform:scale(1) rotate(-5deg)}to{transform:scale(1.15) rotate(5deg)}}
    .goat-title{font-size:2rem;font-weight:900;margin-bottom:8px;background:linear-gradient(135deg,var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .goat-msg{color:var(--muted);margin-bottom:20px}
    .goat-coins{font-size:1.5rem;font-weight:900;color:var(--coin);margin:16px 0}

    /* SHOP */
    .shop-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .shop-tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:20px;scrollbar-width:none}
    .shop-tabs::-webkit-scrollbar{display:none}
    .shop-tab{flex-shrink:0;background:var(--glass);border:1px solid var(--gb);border-radius:20px;padding:8px 16px;cursor:pointer;font-family:inherit;font-weight:700;font-size:.85rem;color:var(--muted);transition:all .2s}
    .shop-tab.active{background:rgba(78,205,196,.15);border-color:var(--teal);color:#fff}
    .shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .shop-item{background:var(--glass);border:2px solid var(--gb);border-radius:18px;padding:16px;text-align:center;position:relative;cursor:pointer;transition:all .2s}
    .shop-item.owned{border-color:rgba(6,214,160,.4)}
    .shop-item.equipped{border-color:var(--teal);background:rgba(78,205,196,.08)}
    .shop-item.goat-item{border-color:rgba(255,215,0,.35);background:rgba(255,215,0,.04)}
    .shop-item .preview{height:90px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;border-radius:12px;background:rgba(255,255,255,.04);overflow:hidden}
    .shop-item .iname{font-weight:800;font-size:.9rem;margin-bottom:6px}
    .shop-item .iprice{font-size:.85rem;font-weight:700;color:var(--coin)}
    .si-badge{position:absolute;top:8px;right:8px;border-radius:8px;padding:2px 7px;font-size:.7rem;font-weight:800}
    .si-owned{background:rgba(6,214,160,.2);border:1px solid rgba(6,214,160,.4);color:var(--green)}
    .si-eq{background:rgba(78,205,196,.25);border:1px solid rgba(78,205,196,.5);color:var(--teal)}
    .si-goat{position:absolute;top:6px;left:8px;font-size:.9rem}
    .cant-afford{opacity:.5}

    /* BUILDER */
    .builder-layout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .av-prev-card{background:var(--glass);border:1px solid var(--gb);border-radius:20px;padding:16px;text-align:center}
    .av-svg-wrap{display:flex;justify-content:center;align-items:center;height:200px;margin-bottom:12px}
    .builder-controls{display:flex;flex-direction:column;gap:6px;overflow-y:auto;max-height:320px}
    .b-cat{font-size:.75rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin:8px 0 4px}
    .b-items{display:flex;flex-wrap:wrap;gap:5px}
    .b-chip{background:var(--glass);border:2px solid var(--gb);border-radius:10px;padding:5px 9px;cursor:pointer;font-size:.78rem;font-weight:700;transition:all .15s;white-space:nowrap}
    .b-chip.active{border-color:var(--teal);color:var(--teal)}
    .b-chip.locked{opacity:.4;cursor:default}
    .b-row{display:flex;gap:8px;flex-wrap:wrap}
    .b-dot{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s;flex-shrink:0}
    .b-dot.active{border-color:var(--teal);box-shadow:0 0 0 2px rgba(78,205,196,.4)}
    .b-hdot{width:28px;height:18px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all .15s}
    .b-hdot.active{border-color:var(--teal)}

    /* STATS */
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
    .stat-card{background:var(--glass);border:1px solid var(--gb);border-radius:16px;padding:16px;text-align:center}
    .s-val{font-size:1.8rem;font-weight:900;color:var(--teal);margin-bottom:4px}
    .s-lbl{font-size:.8rem;color:var(--muted)}
    .g-table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:12px}
    .g-table th{color:var(--muted);font-size:.78rem;text-transform:uppercase;letter-spacing:.05em;text-align:left;padding:0 10px 6px}
    .g-table td{background:var(--glass);padding:9px 10px;font-weight:700;font-size:.85rem}
    .g-table td:first-child{border-radius:10px 0 0 10px}
    .g-table td:last-child{border-radius:0 10px 10px 0;color:var(--teal)}
    .acc-bar{height:5px;background:rgba(255,255,255,.1);border-radius:5px;overflow:hidden;margin-top:3px}
    .acc-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--green));border-radius:5px}
    .game-row{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--glass);border-radius:12px;margin-bottom:6px;font-size:.88rem}
    .game-row-lbl{color:var(--muted)}
    .game-row-val{font-weight:800}

    /* CONFETTI */
    #confetti-c{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000;overflow:hidden}
    @keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}

    @media(max-width:400px){
      .builder-layout,.mc-grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div id="app">
<div id="confetti-c"></div>

<!-- WELCOME -->
<div id="screen-welcome" class="screen">
  <div style="text-align:center;padding:20px 0 28px">
    <div style="font-size:3.8rem;margin-bottom:12px">üöÄ</div>
    <h2 style="font-size:1.8rem;font-weight:900;margin-bottom:8px;background:linear-gradient(135deg,var(--yellow),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Learning Quest</h2>
    <p style="color:var(--muted)">Math ¬∑ Spelling ¬∑ Geography ¬∑ Scramble ¬∑ Mix</p>
  </div>
  <div id="player-list-section" style="display:none">
    <p style="color:var(--muted);font-size:.85rem;margin-bottom:10px">Welcome back! Pick your hero:</p>
    <div class="player-list" id="player-list"></div>
    <div style="text-align:center;margin:12px 0;color:var(--dim);font-size:.85rem">‚Äî or add a new player ‚Äî</div>
  </div>
  <div class="card">
    <p style="font-weight:700;margin-bottom:10px;font-size:.9rem;color:var(--muted)">NEW PLAYER? ENTER YOUR NAME</p>
    <input class="inp" id="name-input" type="text" placeholder="Your name..." maxlength="20" autocomplete="off">
    <button class="btn btn-primary" onclick="beginNewPlayer()" style="margin-top:14px">‚ú® Start Adventure!</button>
  </div>
</div>

<!-- AVATAR TYPE -->
<div id="screen-avatar-type" class="screen">
  <button class="back-btn" onclick="showScreen('welcome')">‚Üê Back</button>
  <div class="sec-title">Choose Your Hero! üéÆ</div>
  <div class="type-grid">
    <div class="type-card" onclick="selectAvatarType('boy')"><div class="type-icon">üßí</div><div class="type-name">Boy</div></div>
    <div class="type-card" onclick="selectAvatarType('girl')"><div class="type-icon">üëß</div><div class="type-name">Girl</div></div>
    <div class="type-card" onclick="selectAvatarType('explorer')"><div class="type-icon">üßë‚ÄçüöÄ</div><div class="type-name">Explorer</div></div>
  </div>
</div>

<!-- SKIN/HAIR -->
<div id="screen-skin-tone" class="screen">
  <button class="back-btn" onclick="showScreen('avatar-type')">‚Üê Back</button>
  <div class="sec-title">Customize Your Look ‚ú®</div>
  <div class="card">
    <p style="font-weight:800;margin-bottom:12px">Skin Tone</p>
    <div class="skin-grid" id="skin-grid"></div>
    <p style="font-weight:800;margin:14px 0 12px">Hair Color</p>
    <div class="hair-grid" id="hair-grid"></div>
  </div>
  <div style="text-align:center;margin-top:12px">
    <div id="skin-preview" style="display:flex;justify-content:center;margin-bottom:14px"></div>
    <button class="btn btn-primary" onclick="finishAvatarSetup()">Looks Great! Let's Go! üéâ</button>
  </div>
</div>

<!-- HUB -->
<div id="screen-hub" class="screen">
  <div class="hub-hdr">
    <div>
      <div class="hub-welcome">Hey, <span id="hub-name">Player</span>!</div>
      <div style="color:var(--muted);font-size:.8rem" id="hub-grade-display">Ready to play!</div>
    </div>
    <div class="coin-badge">ü™ô <span id="hub-coins">0</span></div>
  </div>
  <div class="hub-av-sec">
    <div class="hub-av-prev" id="hub-avatar"></div>
    <div class="hub-stats">
      <div class="stat-row"><span class="stat-lbl">Best Level</span><span class="stat-val" id="hub-level">‚Äî</span></div>
      <div class="stat-row"><span class="stat-lbl">Correct</span><span class="stat-val" id="hub-correct">‚Äî</span></div>
      <div class="stat-row"><span class="stat-lbl">Accuracy</span><span class="stat-val" id="hub-acc">‚Äî</span></div>
      <div class="stat-row"><span class="stat-lbl">GOATs</span><span class="stat-val" id="hub-goats">üêê 0</span></div>
    </div>
  </div>
  <div class="hub-nav">
    <button class="hub-btn play-btn" onclick="startPlayFlow()"><div class="ni">üéÆ</div><div class="nl">Play Now!</div></button>
    <button class="hub-btn" onclick="showScreen('shop')"><div class="ni">üõí</div><div class="nl">Shop</div></button>
    <button class="hub-btn" onclick="showScreen('avatar-builder')"><div class="ni">üé®</div><div class="nl">Avatar</div></button>
    <button class="hub-btn" onclick="showScreen('stats')"><div class="ni">üìä</div><div class="nl">Stats</div></button>
  </div>
  <button class="btn btn-secondary" style="margin-top:16px;font-size:.85rem" onclick="switchPlayer()">üîÄ Switch Player</button>
</div>

<!-- SUBJECT -->
<div id="screen-subject" class="screen">
  <button class="back-btn" onclick="showScreen('hub')">‚Üê Hub</button>
  <div class="sec-title">Pick Your Game! üéØ</div>
  <div class="sub-grid">
    <button class="sub-card math" onclick="selectSubject('math')">
      <div class="si">üî¢</div><div class="sl">Math</div><div class="sd">Addition, subtraction, multiply &amp; divide</div>
    </button>
    <button class="sub-card spelling" onclick="selectSubject('spelling')">
      <div class="si">üìù</div><div class="sl">Spelling</div><div class="sd">Hear it, spell it!</div>
    </button>
    <button class="sub-card geography" onclick="selectSubject('geography')">
      <div class="si">üåç</div><div class="sl">Geography</div><div class="sd">US states &amp; world capitals</div>
    </button>
    <button class="sub-card scramble" onclick="selectSubject('scramble')">
      <div class="si">üîÄ</div><div class="sl">Word Scramble</div><div class="sd">Unscramble the letters!</div>
    </button>
    <button class="sub-card mix" onclick="selectSubject('mix')">
      <div class="si">üé≤</div><div class="sl">üåü Mix Mode üåü</div>
      <div class="sd">Random mix of all 4 games ‚Äî expect the unexpected!</div>
    </button>
  </div>
</div>

<!-- VOICE -->
<div id="screen-voice" class="screen">
  <button class="back-btn" onclick="showScreen('subject')">‚Üê Back</button>
  <div class="sec-title">Pick a Voice üé§</div>
  <p style="text-align:center;color:var(--muted);font-size:.85rem;margin-bottom:8px">Tap to preview!</p>
  <div class="voice-grid">
    <div class="voice-card" onclick="pickVoice('woman-us')"><div class="vi">üë©</div><div class="vn">American Woman</div><div class="vd">US English</div></div>
    <div class="voice-card" onclick="pickVoice('man-us')"><div class="vi">üë®</div><div class="vn">American Man</div><div class="vd">US English</div></div>
    <div class="voice-card" onclick="pickVoice('woman-gb')"><div class="vi">üë©‚Äçü¶∞</div><div class="vn">English Woman</div><div class="vd">British</div></div>
    <div class="voice-card" onclick="pickVoice('man-gb')"><div class="vi">üßî</div><div class="vn">English Man</div><div class="vd">British</div></div>
  </div>
  <button class="btn btn-primary" id="confirm-voice-btn" style="display:none" onclick="confirmVoice()">Confirm Voice ‚Üí</button>
</div>

<!-- GRADE -->
<div id="screen-grade" class="screen">
  <button class="back-btn" onclick="goBackFromGrade()">‚Üê Back</button>
  <div class="sec-title" id="grade-title">Choose Your Grade</div>
  <div class="grade-grid">
    <div class="grade-card" onclick="startGame(2)"><div style="font-size:1.5rem;margin-bottom:6px">2Ô∏è‚É£</div><div style="font-weight:800">Grade 2</div></div>
    <div class="grade-card" onclick="startGame(3)"><div style="font-size:1.5rem;margin-bottom:6px">3Ô∏è‚É£</div><div style="font-weight:800">Grade 3</div></div>
    <div class="grade-card" onclick="startGame(4)"><div style="font-size:1.5rem;margin-bottom:6px">4Ô∏è‚É£</div><div style="font-weight:800">Grade 4</div></div>
    <div class="grade-card" onclick="startGame(5)"><div style="font-size:1.5rem;margin-bottom:6px">5Ô∏è‚É£</div><div style="font-weight:800">Grade 5</div></div>
  </div>
</div>

<!-- PLAY -->
<div id="screen-play" class="screen">
  <div class="play-hdr">
    <div class="play-info">
      <span class="badge" id="badge-sub">üî¢ Math</span>
      <span class="badge" id="badge-grade">Grade 2</span>
      <span class="badge" id="badge-lvl">Level 1</span>
      <span class="badge streak" id="badge-streak" style="display:none">üî• 3</span>
    </div>
    <div class="coin-badge">ü™ô <span id="play-coins">0</span></div>
  </div>
  <div class="prog-bar"><div class="prog-fill" id="prog-fill" style="width:0%"></div></div>
  <div class="mix-tag" id="mix-tag"></div>
  <div class="q-card">
    <div class="q-lbl" id="q-lbl">Solve:</div>
    <div class="q-text" id="q-text">‚Äî</div>
    <div class="q-sub" id="q-sub"></div>
  </div>
  <div id="feedback" class="feedback"></div>
  <div class="hint-txt" id="hint-txt"></div>
  <!-- text input -->
  <div class="ans-area" id="text-area">
    <input class="inp" id="answer-input" type="text" placeholder="Your answer..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    <button class="btn btn-green" style="width:auto;margin:0;padding:14px 20px" onclick="checkTextAnswer()">‚úì</button>
  </div>
  <!-- MC -->
  <div class="mc-grid" id="mc-area" style="display:none"></div>
  <!-- Scramble -->
  <div id="scr-area" style="display:none">
    <p style="text-align:center;color:var(--muted);font-size:.8rem;margin-bottom:6px">Tap letters to build the word ¬∑ Tap answer letters to remove</p>
    <div class="ans-tiles" id="ans-tiles"></div>
    <div class="scr-tiles" id="scr-tiles"></div>
    <div style="display:flex;gap:10px;margin-top:8px">
      <button class="btn btn-secondary btn-sm" style="flex:1" onclick="clearScramble()">üóë Clear</button>
      <button class="btn btn-green btn-sm" style="flex:1" onclick="submitScramble()">‚úì Submit</button>
    </div>
  </div>
  <div style="display:flex;gap:10px;margin-top:8px">
    <button class="btn btn-secondary btn-sm" id="repeat-btn" style="display:none" onclick="speakWord()">üîä Repeat</button>
    <button class="btn btn-secondary btn-sm" onclick="goToHub()">üè† Hub</button>
  </div>
</div>

<!-- GOAT -->
<div id="screen-goat" class="screen">
  <span class="goat-emoji">üêê</span>
  <div class="goat-title" id="goat-title">GOAT!</div>
  <div class="goat-msg" id="goat-msg">You are the Greatest of All Time!</div>
  <div class="goat-coins" id="goat-coins">+100 ü™ô</div>
  <div id="goat-av" style="display:flex;justify-content:center;margin:16px 0"></div>
  <button class="btn btn-primary" onclick="keepPlaying()">Keep Going! üöÄ</button>
  <button class="btn btn-secondary" onclick="goToHub()" style="margin-top:8px">Back to Hub üè†</button>
</div>

<!-- SHOP -->
<div id="screen-shop" class="screen">
  <button class="back-btn" onclick="showScreen('hub')">‚Üê Hub</button>
  <div class="shop-hdr">
    <div style="font-size:1.2rem;font-weight:900">üõí Shop</div>
    <div class="coin-badge">ü™ô <span id="shop-coins">0</span></div>
  </div>
  <div class="shop-tabs" id="shop-tabs"></div>
  <div class="shop-grid" id="shop-grid"></div>
  <div style="margin-top:20px;padding-top:14px;border-top:1px solid var(--gb);text-align:center;color:var(--muted);font-size:.85rem">Earn coins by answering correctly! Streaks &amp; level-ups give bonuses.</div>
</div>

<!-- BUILDER -->
<div id="screen-avatar-builder" class="screen">
  <button class="back-btn" onclick="showScreen('hub')">‚Üê Hub</button>
  <div class="sec-title">üé® Avatar Builder</div>
  <div class="builder-layout" id="builder-layout">
    <div class="av-prev-card">
      <div class="av-svg-wrap" id="builder-preview"></div>
      <div style="font-size:.8rem;color:var(--muted)">Your Avatar</div>
    </div>
    <div class="builder-controls" id="builder-controls"></div>
  </div>
  <button class="btn btn-green" style="margin-top:14px" onclick="saveAvatar()">üíæ Save Avatar</button>
</div>

<!-- STATS -->
<div id="screen-stats" class="screen">
  <button class="back-btn" onclick="showScreen('hub')">‚Üê Hub</button>
  <div class="sec-title">üìä Your Stats</div>
  <div id="stats-content"></div>
</div>

<script>
// ============================================================
//  DATA CONSTANTS
// ============================================================
const SKINS={light:{id:'light',color:'#FDDBB4',shadow:'#D4956A'},medium:{id:'medium',color:'#D4956A',shadow:'#B07040'},dark:{id:'dark',color:'#8B5C2A',shadow:'#5C3A10'},fantasy:{id:'fantasy',color:'#B8E0FF',shadow:'#7EB8E8'}};
const HCOLORS={brown:'#5C3A1E',black:'#1a1a2a',blonde:'#C8860A',red:'#A02020',purple:'#6A20A0',teal:'#1A9090'};
const MIX_POOL=['math','spelling','geography','scramble'];
const SHOP={
  hair:{label:'‚úÇÔ∏è Hair',items:{hair_curly:{name:'Curly Cloud',price:100,emoji:'üåÄ'},hair_mohawk:{name:'Wild Mohawk',price:200,emoji:'‚ö°'},hair_long:{name:'Flowing Locks',price:150,emoji:'üåä'},hair_rainbow:{name:'Rainbow Dreads',price:500,emoji:'üåà'}}},
  outfit:{label:'üëï Outfits',items:{outfit_sporty:{name:'Sporty Jersey',price:75,emoji:'üèÜ'},outfit_wizard:{name:'Wizard Robes',price:200,emoji:'üîÆ'},outfit_dragon:{name:'Dragon Armor',price:450,emoji:'üêâ'},outfit_goat:{name:'GOAT Robe',price:900,emoji:'üêê',isGoat:true}}},
  hat:{label:'üé© Hats',items:{hat_cap:{name:'Baseball Cap',price:60,emoji:'üß¢'},hat_wizard:{name:'Wizard Hat',price:150,emoji:'üé©'},hat_crown:{name:'Party Crown',price:300,emoji:'üëë'},hat_goat_crown:{name:'GOAT Crown',price:750,emoji:'üêê',isGoat:true}}},
  accessory:{label:'üï∂Ô∏è Accessories',items:{acc_shades:{name:'Cool Shades',price:80,emoji:'üï∂Ô∏è'},acc_cape:{name:'Hero Cape',price:250,emoji:'ü¶∏'},acc_rocket:{name:'Rocket Pack',price:500,emoji:'üöÄ'},acc_goat_halo:{name:'GOAT Halo',price:999,emoji:'üêê',isGoat:true}}},
  background:{label:'üåå Background',items:{bg_stars:{name:'Starfield',price:100,emoji:'‚≠ê'},bg_rainbow:{name:'Rainbow Sky',price:200,emoji:'üåà'},bg_fire:{name:'Fire Arena',price:400,emoji:'üî•'},bg_goat_meadow:{name:'GOAT Meadow',price:600,emoji:'üêê',isGoat:true}}},
};

// ============================================================
//  WORD/QUESTION BANKS
// ============================================================
const SPELL={
  2:{1:['cat','dog','run','big','sun','hat','bed','map','cup','leg','pig','top','red','box','fun'],2:['jump','play','stop','fish','tree','frog','milk','duck','wish','king','drum','ship','nest','pink','lamp'],3:['happy','green','sleep','black','brown','plant','three','white','small','bring','drink','smile','float','chair','stone'],4:['friend','should','please','school','people','around','before','twelve','change','follow','pretty','always','animal','father','mother'],5:['because','through','thought','brother','another','morning','nothing','tonight','outside','picture','between','hundred','kitchen','blanket','mittens']},
  3:{1:['lake','home','time','five','give','come','some','bone','note','fire','more','side','wide','hope','ride'],2:['begin','study','water','never','after','story','every','again','world','write','start','laugh','power','guess','quiet'],3:['beauty','center','simple','circle','listen','castle','garden','orange','planet','silver','street','bridge','finger','basket','ladder'],4:['trouble','country','weather','journey','already','evening','against','certain','million','special','library','mystery','harvest','balance','captain'],5:['discover','mountain','powerful','exercise','together','southern','daughter','children','complete','although','practice','question','probably','sentence','whatever']},
  4:{1:['code','free','game','huge','race','save','tide','zone','brave','crane','grace','prime','quote','ridge','theme'],2:['adapt','cease','defer','eager','feast','groan','haste','ideal','knack','lapse','manor','niece','onset','grief','blaze'],3:['absence','ancient','bracket','channel','citizen','damage','edition','fashion','gesture','horizon','illusion','mixture','leisure','package','quarrel'],4:['accident','audience','beneath','calendar','champion','decrease','division','enormous','fraction','generous','humidity','identify','jealousy','keyboard','likewise'],5:['abandoned','ambitious','beautiful','calculate','dangerous','efficient','elaborate','fantastic','gradually','happiness','immediate','knowledge','language','necessary','obviously']},
  5:{1:['achieve','acquire','address','advance','benefit','capture','decline','defense','elegant','failure','genuine','hostile','inspire','justice','kingdom'],2:['absolute','accurate','adhesive','adjacent','affection','aggression','agitation','alignment','alliance','altitude','amazement','amendment','ambition','admission','abundant'],3:['accelerate','accomplish','accumulate','adjustment','admiration','advantage','adventure','affordable','aggressive','allegiance','allocation','allowance','ambiguous','appealing','articular'],4:['abbreviate','abnormally','abruptness','absorption','abstinence','accessible','accountable','accurately','achievement','acknowledge','acquisition','adaptation','affiliation','aggravation','agricultural'],5:['abandonment','abbreviation','accomplishment','accountability','acknowledgment','administration','advertisement','affectionate','aggravation','agricultural','alliteration','amplification','anticipation','appreciation','approximately']},
};

const US_STATES=[
  {state:'Alabama',capital:'Montgomery'},{state:'Alaska',capital:'Juneau'},{state:'Arizona',capital:'Phoenix'},{state:'Arkansas',capital:'Little Rock'},{state:'California',capital:'Sacramento'},
  {state:'Colorado',capital:'Denver'},{state:'Connecticut',capital:'Hartford'},{state:'Delaware',capital:'Dover'},{state:'Florida',capital:'Tallahassee'},{state:'Georgia',capital:'Atlanta'},
  {state:'Hawaii',capital:'Honolulu'},{state:'Idaho',capital:'Boise'},{state:'Illinois',capital:'Springfield'},{state:'Indiana',capital:'Indianapolis'},{state:'Iowa',capital:'Des Moines'},
  {state:'Kansas',capital:'Topeka'},{state:'Kentucky',capital:'Frankfort'},{state:'Louisiana',capital:'Baton Rouge'},{state:'Maine',capital:'Augusta'},{state:'Maryland',capital:'Annapolis'},
  {state:'Massachusetts',capital:'Boston'},{state:'Michigan',capital:'Lansing'},{state:'Minnesota',capital:'Saint Paul'},{state:'Mississippi',capital:'Jackson'},{state:'Missouri',capital:'Jefferson City'},
  {state:'Montana',capital:'Helena'},{state:'Nebraska',capital:'Lincoln'},{state:'Nevada',capital:'Carson City'},{state:'New Hampshire',capital:'Concord'},{state:'New Jersey',capital:'Trenton'},
  {state:'New Mexico',capital:'Santa Fe'},{state:'New York',capital:'Albany'},{state:'North Carolina',capital:'Raleigh'},{state:'North Dakota',capital:'Bismarck'},{state:'Ohio',capital:'Columbus'},
  {state:'Oklahoma',capital:'Oklahoma City'},{state:'Oregon',capital:'Salem'},{state:'Pennsylvania',capital:'Harrisburg'},{state:'Rhode Island',capital:'Providence'},{state:'South Carolina',capital:'Columbia'},
  {state:'South Dakota',capital:'Pierre'},{state:'Tennessee',capital:'Nashville'},{state:'Texas',capital:'Austin'},{state:'Utah',capital:'Salt Lake City'},{state:'Vermont',capital:'Montpelier'},
  {state:'Virginia',capital:'Richmond'},{state:'Washington',capital:'Olympia'},{state:'West Virginia',capital:'Charleston'},{state:'Wisconsin',capital:'Madison'},{state:'Wyoming',capital:'Cheyenne'},
];

const WORLD_CAPS=[
  {country:'France',capital:'Paris'},{country:'Germany',capital:'Berlin'},{country:'Spain',capital:'Madrid'},{country:'Italy',capital:'Rome'},{country:'United Kingdom',capital:'London'},
  {country:'Japan',capital:'Tokyo'},{country:'China',capital:'Beijing'},{country:'Australia',capital:'Canberra'},{country:'Canada',capital:'Ottawa'},{country:'Brazil',capital:'Bras√≠lia'},
  {country:'Mexico',capital:'Mexico City'},{country:'India',capital:'New Delhi'},{country:'Russia',capital:'Moscow'},{country:'South Korea',capital:'Seoul'},{country:'Egypt',capital:'Cairo'},
  {country:'South Africa',capital:'Pretoria'},{country:'Argentina',capital:'Buenos Aires'},{country:'Greece',capital:'Athens'},{country:'Portugal',capital:'Lisbon'},{country:'Netherlands',capital:'Amsterdam'},
  {country:'Sweden',capital:'Stockholm'},{country:'Norway',capital:'Oslo'},{country:'Denmark',capital:'Copenhagen'},{country:'Poland',capital:'Warsaw'},{country:'Turkey',capital:'Ankara'},
  {country:'Saudi Arabia',capital:'Riyadh'},{country:'Thailand',capital:'Bangkok'},{country:'Indonesia',capital:'Jakarta'},{country:'Nigeria',capital:'Abuja'},{country:'Kenya',capital:'Nairobi'},
  {country:'Peru',capital:'Lima'},{country:'Chile',capital:'Santiago'},{country:'Colombia',capital:'Bogot√°'},{country:'Vietnam',capital:'Hanoi'},{country:'Ukraine',capital:'Kyiv'},
  {country:'Romania',capital:'Bucharest'},{country:'Czech Republic',capital:'Prague'},{country:'Hungary',capital:'Budapest'},{country:'Switzerland',capital:'Bern'},{country:'Austria',capital:'Vienna'},
  {country:'Belgium',capital:'Brussels'},{country:'Ireland',capital:'Dublin'},{country:'Finland',capital:'Helsinki'},{country:'New Zealand',capital:'Wellington'},{country:'Cuba',capital:'Havana'},
  {country:'Jamaica',capital:'Kingston'},{country:'Morocco',capital:'Rabat'},{country:'Pakistan',capital:'Islamabad'},{country:'Philippines',capital:'Manila'},{country:'Bangladesh',capital:'Dhaka'},
];

const SCRAMBLE_BANK={
  2:['cat','dog','sun','fun','run','hat','big','map','cup','red','box','pig','top','bed','leg','jump','play','fish','frog','milk','duck','wish','king','drum','nest','pink','lamp','ship','stop','tree'],
  3:['happy','green','sleep','plant','chair','stone','smile','bring','drink','float','black','brown','begin','study','water','never','story','every','again','world','write','start','laugh','power','quiet','guess'],
  4:['simple','circle','listen','castle','garden','orange','planet','silver','street','bridge','finger','basket','ladder','beauty','center','achieve','bargain','compete','fiction','horizon','lantern','mineral','opinion','portion','reflect'],
  5:['absolute','accurate','addition','affection','altitude','amazement','alliance','ambition','allegiance','adventure','brilliant','calendar','champion','enormous','fraction','generous','identify','keyboard','language','necessary'],
};

// ============================================================
//  STATE
// ============================================================
let G={playerName:'',subject:'',grade:2,difficulty:1,streak:0,consCorrect:0,consWrong:0,usedWords:{},problem:null,voiceType:'woman-us',activeMixGame:'math',mcAnswered:false,scrLetters:[],scrAnswer:[]};
let CP=null; // current player
let tempAv={name:'',avatarType:'boy',skinTone:'light',hairColor:'#5C3A1E'};
let builderEq={};
let shopCat='hair';

// ============================================================
//  PERSISTENCE
// ============================================================
function getPlayers(){try{return JSON.parse(localStorage.getItem('lq_v2')||'{}');}catch{return {};}}
function savePlayers(p){localStorage.setItem('lq_v2',JSON.stringify(p));}
function getP(name){return getPlayers()[name]||null;}

function newPlayer(name,avatarType,skinTone,hairColor){
  const pl=getPlayers();
  pl[name]={name,avatarType,skinTone,hairColor,coins:0,ownedItems:[],
    equipped:{hair:null,outfit:null,hat:null,accessory:null,background:null},
    stats:{totalCorrect:0,totalAttempted:0,highestLevel:1,goatCount:0,
      gradeStats:{2:{c:0,a:0},3:{c:0,a:0},4:{c:0,a:0},5:{c:0,a:0}},
      gameStats:{math:{c:0,a:0},spelling:{c:0,a:0},geography:{c:0,a:0},scramble:{c:0,a:0}},
    }
  };
  savePlayers(pl);return pl[name];
}

function addCoins(name,amt){
  const pl=getPlayers();if(!pl[name])return 0;
  pl[name].coins=(pl[name].coins||0)+amt;savePlayers(pl);return pl[name].coins;
}

function recordStat(name,subject,correct,grade){
  const pl=getPlayers();const p=pl[name];if(!p)return;
  const gs=p.stats.gameStats;if(!gs[subject])gs[subject]={c:0,a:0};
  gs[subject].a++;if(correct)gs[subject].c++;
  p.stats.totalAttempted++;if(correct)p.stats.totalCorrect++;
  if(grade){if(!p.stats.gradeStats[grade])p.stats.gradeStats[grade]={c:0,a:0};p.stats.gradeStats[grade].a++;if(correct)p.stats.gradeStats[grade].c++;}
  savePlayers(pl);
}

// ============================================================
//  SVG AVATAR
// ============================================================
function avatarSVG(type,skinId,hair,eq,sz){
  const sk=SKINS[skinId]||SKINS.light;const s=sk.color,sh=sk.shadow;const hc=hair||HCOLORS.brown;const e=eq||{};
  const w=sz||200,h=sz?Math.round(sz*1.4):280;
  const bg=avBg(e.background);const body=avBody(e.outfit,s);const hback=avHairBack(e.hair||'def',hc,type);
  const head=`<circle cx="100" cy="95" r="58" fill="${s}"/>`;const face=avFace(s,sh,type);
  const hfront=avHairFront(e.hair||'def',hc,type);const hat=e.hat?avHat(e.hat):'';const acc=avAcc(e.accessory,s);
  return`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 280" width="${w}" height="${h}">${bg}${acc.back||''}${body}<rect x="83" y="148" width="34" height="26" fill="${s}" rx="6"/>${hback}${head}${face}${hfront}${hat}${acc.front||''}</svg>`;
}
function avBg(id){
  if(id==='bg_stars')return`<rect width="200" height="280" fill="#0a0820"/><circle cx="30" cy="20" r="1.5" fill="white" opacity=".8"/><circle cx="150" cy="15" r="2" fill="white" opacity=".9"/><circle cx="80" cy="40" r="1" fill="white" opacity=".7"/><circle cx="170" cy="55" r="1" fill="white" opacity=".6"/><circle cx="185" cy="90" r="1.5" fill="white" opacity=".8"/>`;
  if(id==='bg_rainbow')return`<defs><linearGradient id="rg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FF8080"/><stop offset="30%" stop-color="#FFCC80"/><stop offset="60%" stop-color="#80CCFF"/><stop offset="100%" stop-color="#C080FF"/></linearGradient></defs><rect width="200" height="280" fill="url(#rg)"/>`;
  if(id==='bg_fire')return`<defs><linearGradient id="fg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#FF4500"/><stop offset="50%" stop-color="#FF8C00"/><stop offset="100%" stop-color="#FFD700"/></linearGradient></defs><rect width="200" height="280" fill="url(#fg)"/>`;
  if(id==='bg_goat_meadow')return`<defs><linearGradient id="mg" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stop-color="#87CEEB"/><stop offset="60%" stop-color="#98FB98"/><stop offset="100%" stop-color="#228B22"/></linearGradient></defs><rect width="200" height="280" fill="url(#mg)"/><text x="12" y="28" font-size="16">üêê</text><text x="155" y="42" font-size="12">‚≠ê</text>`;
  return`<defs><linearGradient id="dg" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#1a0a3e"/><stop offset="100%" stop-color="#0d1b3e"/></linearGradient></defs><rect width="200" height="280" fill="url(#dg)"/>`;
}
function avBody(id,skin){
  const base=(fill,d='')=>`<path d="M25 180 L45 165 Q65 158 100 156 Q135 158 155 165 L175 180 L175 280 L25 280 Z" fill="${fill}"/><path d="M80 156 Q100 168 120 156" fill="none" stroke="${skin}" stroke-width="8" stroke-linecap="round"/>${d}`;
  if(id==='outfit_sporty')return base('#2244AA',`<rect x="25" y="195" width="150" height="8" fill="rgba(255,255,255,.25)"/><text x="80" y="250" font-size="22" font-weight="bold" fill="rgba(255,255,255,.8)">1</text>`);
  if(id==='outfit_wizard')return base('#6B21A8',`<circle cx="60" cy="200" r="5" fill="rgba(255,220,50,.6)"/><circle cx="140" cy="215" r="4" fill="rgba(255,220,50,.5)"/><circle cx="90" cy="240" r="6" fill="rgba(255,220,50,.7)"/>`);
  if(id==='outfit_dragon')return base('#DC2626',`<path d="M30 200 Q100 190 170 200" fill="none" stroke="#FCD34D" stroke-width="1.5" opacity=".6"/><text x="82" y="255" font-size="20">üî•</text>`);
  if(id==='outfit_goat')return`<path d="M25 180 L45 165 Q65 158 100 156 Q135 158 155 165 L175 180 L175 280 L25 280 Z" fill="#F5D060"/><path d="M80 156 Q100 168 120 156" fill="none" stroke="${skin}" stroke-width="8" stroke-linecap="round"/><text x="72" y="240" font-size="28">üêê</text>`;
  return base('#3B82F6');
}
function avHairBack(id,c,t){
  if(id==='hair_long')return`<rect x="36" y="88" width="22" height="95" rx="11" fill="${c}"/><rect x="142" y="88" width="22" height="95" rx="11" fill="${c}"/>`;
  if(id==='hair_rainbow')return`<rect x="34" y="88" width="16" height="110" rx="8" fill="#FF6B6B"/><rect x="54" y="88" width="16" height="105" rx="8" fill="#FFB347"/><rect x="130" y="88" width="16" height="108" rx="8" fill="#82CA9D"/><rect x="150" y="88" width="16" height="112" rx="8" fill="#87CEEB"/>`;
  return'';
}
function avFace(s,sh,t){
  const nose=`<path d="M96 112 Q100 119 104 112" fill="none" stroke="${sh}" stroke-width="2" stroke-linecap="round" opacity=".7"/>`;
  const mouth=`<path d="M82 122 Q100 136 118 122" fill="none" stroke="#C07860" stroke-width="3.5" stroke-linecap="round"/>`;
  const ears=`<ellipse cx="41" cy="98" rx="8" ry="10" fill="${s}"/><ellipse cx="159" cy="98" rx="8" ry="10" fill="${s}"/>`;
  let eyes='';
  if(t==='girl'){eyes=`<ellipse cx="78" cy="96" rx="13" ry="14" fill="white"/><ellipse cx="122" cy="96" rx="13" ry="14" fill="white"/><circle cx="80" cy="97" r="9" fill="#2C1810"/><circle cx="124" cy="97" r="9" fill="#2C1810"/><circle cx="83" cy="94" r="3.5" fill="white"/><circle cx="127" cy="94" r="3.5" fill="white"/><ellipse cx="68" cy="104" rx="6" ry="3" fill="rgba(220,120,120,.3)"/><ellipse cx="132" cy="104" rx="6" ry="3" fill="rgba(220,120,120,.3)"/>`;
  }else if(t==='explorer'){eyes=`<ellipse cx="78" cy="97" rx="12" ry="11" fill="white"/><ellipse cx="122" cy="97" rx="12" ry="11" fill="white"/><circle cx="80" cy="98" r="8" fill="#1a2a4a"/><circle cx="124" cy="98" r="8" fill="#1a2a4a"/><circle cx="83" cy="95" r="3" fill="white"/><circle cx="127" cy="95" r="3" fill="white"/><line x1="66" y1="87" x2="90" y2="87" stroke="#2C1810" stroke-width="2.5" stroke-linecap="round"/><line x1="110" y1="87" x2="134" y2="87" stroke="#2C1810" stroke-width="2.5" stroke-linecap="round"/>`;
  }else{eyes=`<ellipse cx="78" cy="97" rx="12" ry="13" fill="white"/><ellipse cx="122" cy="97" rx="12" ry="13" fill="white"/><circle cx="80" cy="98" r="8.5" fill="#2C1810"/><circle cx="124" cy="98" r="8.5" fill="#2C1810"/><circle cx="83" cy="95" r="3" fill="white"/><circle cx="127" cy="95" r="3" fill="white"/>`;}
  return ears+nose+eyes+mouth;
}
function avHairFront(id,c,t){
  const boy=`<path d="M42 93 Q42 30 100 30 Q158 30 158 93 Q150 60 100 58 Q50 60 42 93Z" fill="${c}"/>`;
  const girl=`<path d="M42 96 Q42 28 100 28 Q158 28 158 96 Q152 62 100 60 Q48 62 42 96Z" fill="${c}"/><path d="M42 96 Q38 80 42 65 Q45 50 55 42" fill="none" stroke="${c}" stroke-width="16" stroke-linecap="round"/>`;
  const exp=`<path d="M42 90 Q44 28 100 26 Q156 28 158 90 Q150 58 100 56 Q50 58 42 90Z" fill="${c}"/><path d="M42 85 Q33 73 42 58" fill="none" stroke="${c}" stroke-width="14" stroke-linecap="round"/>`;
  if(id==='def')return t==='girl'?girl:t==='explorer'?exp:boy;
  if(id==='hair_curly')return`<circle cx="52" cy="55" r="18" fill="${c}"/><circle cx="70" cy="38" r="16" fill="${c}"/><circle cx="100" cy="32" r="20" fill="${c}"/><circle cx="130" cy="38" r="16" fill="${c}"/><circle cx="148" cy="55" r="18" fill="${c}"/><circle cx="42" cy="75" r="14" fill="${c}"/><circle cx="158" cy="75" r="14" fill="${c}"/>`;
  if(id==='hair_mohawk')return`<path d="M42 92 Q60 95 70 70 Q80 90 90 50 Q100 30 110 50 Q120 90 130 70 Q140 95 158 92 Q148 68 100 58 Q52 68 42 92Z" fill="${c}"/>`;
  if(id==='hair_long'||id==='hair_rainbow')return`<path d="M42 94 Q42 30 100 28 Q158 30 158 94 Q152 62 100 60 Q48 62 42 94Z" fill="${c}"/>`;
  return t==='girl'?girl:boy;
}
function avHat(id){
  if(id==='hat_cap')return`<rect x="58" y="52" width="84" height="28" rx="6" fill="#1a4a8a"/><rect x="45" y="74" width="110" height="14" rx="5" fill="#1a3a6a"/>`;
  if(id==='hat_wizard')return`<path d="M100 -5 L70 72 L130 72 Z" fill="#6B21A8"/><ellipse cx="100" cy="72" rx="38" ry="12" fill="#7C3AED"/><circle cx="100" cy="15" r="5" fill="#FFD700"/>`;
  if(id==='hat_crown')return`<path d="M65 75 L65 50 L82 65 L100 42 L118 65 L135 50 L135 75 Z" fill="#FFD700"/><rect x="63" y="73" width="74" height="16" rx="5" fill="#FFC107"/><circle cx="100" cy="44" r="6" fill="#4444FF"/>`;
  if(id==='hat_goat_crown')return`<path d="M65 75 L65 45 L82 62 L100 38 L118 62 L135 45 L135 75 Z" fill="#FFD700"/><rect x="62" y="73" width="76" height="18" rx="6" fill="#FFC107"/><text x="84" y="92" font-size="13" fill="#7a3500">üêê</text>`;
  return'';
}
function avAcc(id,skin){
  if(id==='acc_shades')return{front:`<rect x="62" y="91" width="30" height="18" rx="7" fill="#1a1a2a"/><rect x="108" y="91" width="30" height="18" rx="7" fill="#1a1a2a"/><rect x="90" y="96" width="20" height="4" rx="2" fill="#333"/><rect x="64" y="93" width="26" height="14" rx="6" fill="#2255CC" opacity=".6"/><rect x="110" y="93" width="26" height="14" rx="6" fill="#2255CC" opacity=".6"/>`,back:''};
  if(id==='acc_cape')return{back:`<path d="M55 165 Q40 190 35 280 L55 280 Q70 220 100 210 Q130 220 145 280 L165 280 Q160 190 145 165Z" fill="#DC2626" opacity=".9"/>`,front:''};
  if(id==='acc_rocket')return{back:`<rect x="155" y="155" width="22" height="45" rx="8" fill="#9CA3AF"/><path d="M155 155 Q166 135 177 155Z" fill="#EF4444"/><path d="M155 200 Q160 215 165 200" fill="#FB923C" opacity=".8"/>`,front:''};
  if(id==='acc_goat_halo')return{front:`<ellipse cx="100" cy="18" rx="36" ry="10" fill="none" stroke="#FFD700" stroke-width="5"/><text x="84" y="8" font-size="12">üêê</text>`,back:''};
  return{front:'',back:''};
}

// ============================================================
//  MATH
// ============================================================
function mathProb(grade,diff){
  const r=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  let a,b,op,ans;
  if(grade<=2){
    if(diff<=2){a=r(1,20);b=r(1,20-a);op='+';ans=a+b;}
    else if(diff<=4){if(r(0,1)===0){a=r(5,20);b=r(1,a);op='-';ans=a-b;}else{a=r(1,10);b=r(2,5);op='√ó';ans=a*b;}}
    else{a=r(2,10);b=r(2,5);op='√ó';ans=a*b;}
  }else if(grade===3){
    if(diff<=2){a=r(10,99);b=r(10,99);op='+';ans=a+b;}
    else if(diff<=4){const t=r(0,2);if(t===0){a=r(20,99);b=r(10,a);op='-';ans=a-b;}else if(t===1){a=r(2,12);b=r(2,12);op='√ó';ans=a*b;}else{b=r(2,9);a=b*r(2,10);op='√∑';ans=a/b;}}
    else{a=r(4,12);b=r(4,12);op='√ó';ans=a*b;}
  }else if(grade===4){
    if(diff<=2){a=r(10,99);b=r(10,99);op='√ó';ans=a*b;}
    else{b=r(2,9);a=b*r(2,12);op='√∑';ans=a/b;}
  }else{
    if(diff<=2){a=r(100,999);b=r(100,999);op='+';ans=a+b;}
    else{a=r(12,99);b=r(12,99);op='√ó';ans=a*b;}
  }
  return{q:`${a} ${op} ${b} = ?`,answer:String(ans),type:'text'};
}

// ============================================================
//  SPELLING
// ============================================================
function spellProb(grade,diff){
  const bank=SPELL[grade]?.[diff]||SPELL[2][1];
  const key=`sp_${grade}_${diff}`;
  if(!G.usedWords[key])G.usedWords[key]=[];
  let avail=bank.filter(w=>!G.usedWords[key].includes(w));
  if(!avail.length){G.usedWords[key]=[];avail=[...bank];}
  const word=avail[Math.floor(Math.random()*avail.length)];
  G.usedWords[key].push(word);
  return{q:word,answer:word,type:'text'};
}

// ============================================================
//  GEOGRAPHY
// ============================================================
function geoProb(grade,diff){
  // diff 1-2: US states MC, diff 3-4: world MC, diff 5: world type
  function pickFrom(pool,keyStr){
    const key=`geo_${keyStr}`;
    if(!G.usedWords[key])G.usedWords[key]=[];
    let avail=pool.filter(x=>!G.usedWords[key].includes(x.state||x.country));
    if(!avail.length){G.usedWords[key]=[];avail=[...pool];}
    const item=avail[Math.floor(Math.random()*avail.length)];
    G.usedWords[key].push(item.state||item.country);
    return item;
  }
  function mcChoices(correct,pool,n=4){
    const all=pool.map(x=>x.capital);
    const wrong=all.filter(c=>c!==correct).sort(()=>Math.random()-.5).slice(0,n-1);
    return[correct,...wrong].sort(()=>Math.random()-.5);
  }
  if(diff<=2){
    const item=pickFrom(US_STATES,'us');
    return{q:`What is the capital of ${item.state}?`,answer:item.capital,type:'mc',choices:mcChoices(item.capital,US_STATES),sub:'üá∫üá∏ US State Capitals'};
  }else if(diff<=4){
    const item=pickFrom(WORLD_CAPS,'world');
    return{q:`What is the capital of ${item.country}?`,answer:item.capital,type:'mc',choices:mcChoices(item.capital,WORLD_CAPS),sub:'üåç World Capitals'};
  }else{
    const item=pickFrom(WORLD_CAPS,'world_type');
    return{q:`What is the capital of ${item.country}?`,answer:item.capital,type:'text',sub:'üåç Type the capital city'};
  }
}

// ============================================================
//  SCRAMBLE
// ============================================================
function scrambleProb(grade,diff){
  const g=Math.min(Math.max(grade,2),5);
  const bank=SCRAMBLE_BANK[g]||SCRAMBLE_BANK[2];
  let filtered=diff<=2?bank.filter(w=>w.length<=5):diff<=4?bank.filter(w=>w.length>=4&&w.length<=8):bank.filter(w=>w.length>=6);
  if(!filtered.length)filtered=bank;
  const key=`scr_${grade}_${diff}`;
  if(!G.usedWords[key])G.usedWords[key]=[];
  let avail=filtered.filter(w=>!G.usedWords[key].includes(w));
  if(!avail.length){G.usedWords[key]=[];avail=[...filtered];}
  const word=avail[Math.floor(Math.random()*avail.length)];
  G.usedWords[key].push(word);
  let sc=word.split('').sort(()=>Math.random()-.5);
  let tries=0;while(sc.join('')===word&&tries<20){sc=word.split('').sort(()=>Math.random()-.5);tries++;}
  return{q:sc.join('').toUpperCase(),answer:word,type:'scramble',letters:sc.map((l,i)=>({l:l.toUpperCase(),i,used:false}))};
}

// ============================================================
//  SCREEN NAV
// ============================================================
function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById('screen-'+name);
  if(el){el.classList.add('active');window.scrollTo(0,0);}
  if(name==='shop')renderShop();
  if(name==='avatar-builder')renderBuilder();
  if(name==='stats')renderStats();
  if(name==='hub')renderHub();
  if(name==='welcome')renderWelcome();
}

// ============================================================
//  WELCOME
// ============================================================
function renderWelcome(){
  const pl=getPlayers(),names=Object.keys(pl);
  const sec=document.getElementById('player-list-section'),lst=document.getElementById('player-list');
  if(names.length){
    sec.style.display='block';
    lst.innerHTML=names.map(n=>{
      const p=pl[n];
      const mini=avatarSVG(p.avatarType||'boy',p.skinTone||'light',p.hairColor||HCOLORS.brown,p.equipped||{},36);
      return`<div class="player-chip" onclick="loginPlayer('${n}')">
        <div class="player-info"><div class="p-avatar-mini">${mini}</div>
        <div><div class="p-name">${n}</div><div class="p-meta">${p.lastGrade?'Grade '+p.lastGrade:'Ready!'} ¬∑ Lvl ${p.stats?.highestLevel||1}</div></div></div>
        <div class="p-coins">ü™ô ${p.coins||0}</div>
      </div>`;
    }).join('');
  }else sec.style.display='none';
}
function beginNewPlayer(){
  const name=document.getElementById('name-input').value.trim();
  if(!name){alert('Enter your name!');return;}
  if(getP(name)){loginPlayer(name);return;}
  tempAv.name=name;showScreen('avatar-type');
}
function loginPlayer(name){CP=getP(name);G.playerName=name;renderHub();showScreen('hub');}
function switchPlayer(){CP=null;document.getElementById('name-input').value='';renderWelcome();showScreen('welcome');}

// ============================================================
//  AVATAR SETUP
// ============================================================
function selectAvatarType(t){
  tempAv.avatarType=t;
  document.querySelectorAll('.type-card').forEach(c=>c.classList.remove('sel'));
  event.currentTarget.classList.add('sel');
  setTimeout(()=>{showScreen('skin-tone');renderSkinScreen();},200);
}
function renderSkinScreen(){
  document.getElementById('skin-grid').innerHTML=Object.values(SKINS).map(st=>
    `<div class="skin-sw ${tempAv.skinTone===st.id?'sel':''}" style="background:${st.color}" onclick="setSkin('${st.id}')"></div>`).join('');
  document.getElementById('hair-grid').innerHTML=Object.entries(HCOLORS).map(([n,c])=>
    `<div class="hair-sw ${tempAv.hairColor===c?'sel':''}" style="background:${c}" onclick="setHair('${c}')"></div>`).join('');
  updateSkinPrev();
}
function setSkin(id){tempAv.skinTone=id;document.querySelectorAll('.skin-sw').forEach((s,i)=>s.classList.toggle('sel',Object.keys(SKINS)[i]===id));updateSkinPrev();}
function setHair(c){tempAv.hairColor=c;document.querySelectorAll('.hair-sw').forEach(s=>s.classList.toggle('sel',s.style.background===c||s.style.background===`rgb(${hx(c)})`));updateSkinPrev();}
function hx(hex){const r=parseInt(hex.slice(1,3),16),gr=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return`${r}, ${gr}, ${b}`;}
function updateSkinPrev(){document.getElementById('skin-preview').innerHTML=avatarSVG(tempAv.avatarType,tempAv.skinTone,tempAv.hairColor,{},100);}
function finishAvatarSetup(){newPlayer(tempAv.name,tempAv.avatarType,tempAv.skinTone,tempAv.hairColor);CP=getP(tempAv.name);G.playerName=tempAv.name;renderHub();showScreen('hub');}

// ============================================================
//  HUB
// ============================================================
function renderHub(){
  if(!CP)return;
  const p=getP(CP.name);CP=p;
  document.getElementById('hub-name').textContent=p.name;
  document.getElementById('hub-coins').textContent=p.coins||0;
  document.getElementById('hub-grade-display').textContent=p.lastGrade?`Last played: Grade ${p.lastGrade}`:'Ready to play!';
  document.getElementById('hub-level').textContent=`Level ${p.stats?.highestLevel||1}`;
  document.getElementById('hub-correct').textContent=p.stats?.totalCorrect||0;
  const acc=p.stats?.totalAttempted>0?Math.round(p.stats.totalCorrect/p.stats.totalAttempted*100)+'%':'‚Äî';
  document.getElementById('hub-acc').textContent=acc;
  document.getElementById('hub-goats').textContent=`üêê ${p.stats?.goatCount||0}`;
  document.getElementById('hub-avatar').innerHTML=avatarSVG(p.avatarType||'boy',p.skinTone||'light',p.hairColor||HCOLORS.brown,p.equipped||{},100);
}

// ============================================================
//  PLAY FLOW
// ============================================================
function startPlayFlow(){showScreen('subject');}
function selectSubject(s){
  G.subject=s;
  if(s==='spelling'){showScreen('voice');}
  else{
    const labels={math:'üî¢ Math',geography:'üåç Geography',scramble:'üîÄ Word Scramble',mix:'üé≤ Mix Mode'};
    document.getElementById('grade-title').textContent=`${labels[s]||s} ‚Äî Choose Grade`;
    showScreen('grade');
  }
}
function goBackFromGrade(){showScreen(G.subject==='spelling'?'voice':'subject');}

// VOICE
let selVoice='woman-us';
function pickVoice(t){
  selVoice=t;
  document.querySelectorAll('.voice-card').forEach(c=>c.classList.remove('sel'));
  event.currentTarget.classList.add('sel');
  document.getElementById('confirm-voice-btn').style.display='inline-flex';
  if('speechSynthesis' in window){
    window.speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(`Hi ${G.playerName||'there'}! Ready to spell?`);
    applyVoice(u,t);window.speechSynthesis.speak(u);
  }
}
function applyVoice(u,t){
  u.rate=0.72;u.pitch=1.0;u.volume=1.0;
  if('speechSynthesis' in window){
    const vs=window.speechSynthesis.getVoices();let v=null;
    if(t==='woman-us')v=vs.find(x=>x.lang.startsWith('en-US')&&!x.name.toLowerCase().includes('male'))||vs.find(x=>x.lang.startsWith('en-US'));
    else if(t==='man-us')v=vs.find(x=>x.lang.startsWith('en-US')&&x.name.toLowerCase().includes('male'))||vs.find(x=>x.lang.startsWith('en-US'));
    else if(t==='woman-gb')v=vs.find(x=>x.lang.startsWith('en-GB')&&!x.name.toLowerCase().includes('male'))||vs.find(x=>x.lang.startsWith('en-GB'));
    else if(t==='man-gb')v=vs.find(x=>x.lang.startsWith('en-GB')&&x.name.toLowerCase().includes('male'))||vs.find(x=>x.lang.startsWith('en-GB'));
    if(v)u.voice=v;
  }
}
function confirmVoice(){G.voiceType=selVoice;document.getElementById('grade-title').textContent='üìù Spelling ‚Äî Choose Grade';showScreen('grade');}

// START GAME
function startGame(grade){
  G.grade=grade;G.difficulty=1;G.streak=0;G.consCorrect=0;G.consWrong=0;G.usedWords={};G.mcAnswered=false;
  const pl=getPlayers();if(pl[CP.name]){pl[CP.name].lastGrade=grade;savePlayers(pl);}
  generateProblem();showScreen('play');updatePlayUI();
  if(G.subject!=='scramble')setTimeout(()=>document.getElementById('answer-input').focus(),300);
}

// ============================================================
//  PROBLEM GENERATION
// ============================================================
function activeGame(){return G.subject==='mix'?G.activeMixGame:G.subject;}

function generateProblem(){
  if(G.subject==='mix')G.activeMixGame=MIX_POOL[Math.floor(Math.random()*MIX_POOL.length)];
  const ag=activeGame();
  if(ag==='math')G.problem=mathProb(G.grade,G.difficulty);
  else if(ag==='spelling')G.problem=spellProb(G.grade,G.difficulty);
  else if(ag==='geography')G.problem=geoProb(G.grade,G.difficulty);
  else if(ag==='scramble'){G.problem=scrambleProb(G.grade,G.difficulty);G.scrLetters=[...G.problem.letters];G.scrAnswer=[];}
  G.mcAnswered=false;
  document.getElementById('answer-input').value='';
  document.getElementById('feedback').style.display='none';
  document.getElementById('hint-txt').style.display='none';
  updatePlayUI();
  if(ag==='spelling')setTimeout(()=>speakWord(),400);
  if(G.problem.type!=='scramble'&&G.problem.type!=='mc')setTimeout(()=>document.getElementById('answer-input').focus(),100);
}

// ============================================================
//  PLAY UI
// ============================================================
const SUBCOLOR={math:'#4ECDC4',spelling:'#A78BFA',geography:'#06D6A0',scramble:'#F97316',mix:'#FFE66D'};
const SUBLABEL={math:'üî¢ Math',spelling:'üìù Spelling',geography:'üåç Geography',scramble:'üîÄ Scramble',mix:'üé≤ Mix'};
const MIXLABEL={math:'üî¢ Math Question',spelling:'üìù Spelling',geography:'üåç Geography',scramble:'üîÄ Word Scramble'};

function updatePlayUI(){
  const ag=activeGame();
  const subBadge=document.getElementById('badge-sub');
  subBadge.textContent=SUBLABEL[G.subject]||G.subject;
  document.getElementById('badge-grade').textContent=`Grade ${G.grade}`;
  document.getElementById('badge-lvl').textContent=`Level ${G.difficulty}`;
  const sb=document.getElementById('badge-streak');
  if(G.streak>=3){sb.style.display='inline-block';sb.textContent=`üî• ${G.streak}`;}else sb.style.display='none';
  document.getElementById('prog-fill').style.width=Math.min((G.consCorrect/5)*100,100)+'%';
  const p=getP(CP.name);document.getElementById('play-coins').textContent=p?.coins||0;
  // mix tag
  const mt=document.getElementById('mix-tag');
  if(G.subject==='mix'){mt.style.display='block';mt.innerHTML=`<span class="mix-pill" style="background:${SUBCOLOR[ag]}22;border:1px solid ${SUBCOLOR[ag]}55;color:${SUBCOLOR[ag]}">${MIXLABEL[ag]||ag}</span>`;}
  else mt.style.display='none';
  // toggle input modes
  document.getElementById('text-area').style.display='none';
  document.getElementById('mc-area').style.display='none';
  document.getElementById('scr-area').style.display='none';
  document.getElementById('repeat-btn').style.display='none';
  const prob=G.problem;if(!prob)return;
  const ql=document.getElementById('q-lbl'),qt=document.getElementById('q-text'),qs=document.getElementById('q-sub');
  if(ag==='math'){ql.textContent='Solve this:';qt.style.fontSize='2rem';qt.textContent=prob.q;qs.textContent='';document.getElementById('text-area').style.display='flex';}
  else if(ag==='spelling'){ql.textContent='Spell this word:';qt.style.fontSize='2rem';qt.textContent='üîä Listen!';qs.textContent='Tap Repeat to hear it again';document.getElementById('text-area').style.display='flex';document.getElementById('repeat-btn').style.display='inline-flex';}
  else if(ag==='geography'){ql.textContent=prob.sub||'Geography:';qt.style.fontSize=prob.q.length>40?'1.3rem':'1.6rem';qt.textContent=prob.q;qs.textContent='';
    if(prob.type==='mc'){document.getElementById('mc-area').style.display='grid';renderMC(prob.choices,prob.answer);}
    else{document.getElementById('text-area').style.display='flex';qs.textContent='Type the capital city';}
  }else if(ag==='scramble'){ql.textContent='Unscramble these letters:';qt.style.fontSize='2rem';qt.textContent=prob.q;qs.textContent=`${prob.answer.length} letters`;document.getElementById('scr-area').style.display='block';renderScrTiles();}
}

// ============================================================
//  MC (Geography)
// ============================================================
function renderMC(choices,answer){
  document.getElementById('mc-area').innerHTML=choices.map(c=>`<button class="mc-btn" onclick="handleMC(this,'${c.replace(/'/g,"\\'")}')" data-val="${c.replace(/"/g,'&quot;')}">${c}</button>`).join('');
  // store correct in a data attr
  document.getElementById('mc-area').dataset.answer=answer;
}
function handleMC(btn,chosen){
  if(G.mcAnswered)return;G.mcAnswered=true;
  const correct=document.getElementById('mc-area').dataset.answer;
  const isOk=chosen===correct;
  document.querySelectorAll('.mc-btn').forEach(b=>{
    if(b.dataset.val===correct)b.classList.add('correct-ans');
    else if(b.dataset.val===chosen&&!isOk)b.classList.add('wrong-ans');
    b.style.pointerEvents='none';
  });
  handleResult(isOk,'geography',chosen,correct);
}

// ============================================================
//  SCRAMBLE TILES
// ============================================================
function renderScrTiles(){
  document.getElementById('scr-tiles').innerHTML=G.scrLetters.map((l,i)=>l.used?`<div class="scr-tile used">${l.l}</div>`:`<div class="scr-tile" onclick="addScrLetter(${i})">${l.l}</div>`).join('');
  document.getElementById('ans-tiles').innerHTML=G.scrAnswer.map((e,i)=>`<div class="ans-tile" onclick="removeScrLetter(${i})">${e.l}</div>`).join('');
}
function addScrLetter(i){if(G.scrLetters[i].used)return;G.scrLetters[i].used=true;G.scrAnswer.push({l:G.scrLetters[i].l,i});renderScrTiles();}
function removeScrLetter(ai){const e=G.scrAnswer[ai];G.scrLetters[e.i].used=false;G.scrAnswer.splice(ai,1);renderScrTiles();}
function clearScramble(){G.scrAnswer.forEach(e=>G.scrLetters[e.i].used=false);G.scrAnswer=[];renderScrTiles();}
function submitScramble(){
  if(!G.scrAnswer.length){alert('Tap some letters first!');return;}
  const ua=G.scrAnswer.map(e=>e.l).join('').toLowerCase();
  const ok=ua===G.problem.answer.toLowerCase();
  handleResult(ok,'scramble',ua,G.problem.answer);
  if(!ok)setTimeout(()=>{clearScramble();if(G.consWrong>=2){const h=document.getElementById('hint-txt');h.style.display='block';h.textContent=`Hint: ${G.problem.answer.slice(0,2)}${'_'.repeat(G.problem.answer.length-2)}`;}},800);
}

// ============================================================
//  TEXT ANSWER
// ============================================================
function checkTextAnswer(){
  const val=document.getElementById('answer-input').value.trim();if(!val||!G.problem)return;
  const ag=activeGame();const ok=val.toLowerCase()===G.problem.answer.toString().toLowerCase();
  handleResult(ok,ag,val,G.problem.answer);
  if(!ok){
    if(ag==='spelling'){setTimeout(()=>speakWord(),800);if(G.consWrong>=2){const h=document.getElementById('hint-txt');h.style.display='block';h.textContent=`Hint: ${G.problem.answer.slice(0,2)}${'_'.repeat(G.problem.answer.length-2)}`;}}
    if(ag==='geography'){if(G.consWrong>=2){const h=document.getElementById('hint-txt');h.style.display='block';h.textContent=`Hint: ${G.problem.answer.slice(0,2)}...`;}}
  }
}

// ============================================================
//  CORE RESULT HANDLER
// ============================================================
function handleResult(ok,subject,userVal,correctVal){
  recordStat(CP.name,subject,ok,G.grade);
  const fb=document.getElementById('feedback');fb.style.display='block';
  if(ok){
    G.streak++;G.consCorrect++;G.consWrong=0;
    const base=G.difficulty*5;const bonus=G.streak>=5?5:G.streak>=3?2:0;const earned=base+bonus;
    const total=addCoins(CP.name,earned);
    document.getElementById('play-coins').textContent=total;
    coinPop(earned);
    fb.className='feedback correct';
    fb.innerHTML=`‚úÖ Correct! +${earned} ü™ô${bonus>0?' (üî• streak bonus!)':''}`;
    if(G.consCorrect>=5){
      G.consCorrect=0;G.difficulty++;
      const lBonus=25;addCoins(CP.name,lBonus);
      fb.innerHTML+=` üéâ LEVEL UP! +${lBonus} ü™ô`;
      updateHighestLevel();
      if(G.difficulty>5){setTimeout(()=>goat(),900);return;}
    }
    setTimeout(()=>generateProblem(),1400);
  }else{
    G.streak=0;G.consWrong++;G.consCorrect=Math.max(0,G.consCorrect-1);
    fb.className='feedback wrong';
    if(subject==='geography'||subject==='scramble')fb.innerHTML=`‚ùå Not quite! Answer: <strong>${correctVal}</strong>`;
    else if(subject==='spelling')fb.textContent='‚ùå Not quite ‚Äî listen again!';
    else fb.textContent='‚ùå Not quite! Try again.';
    if(G.difficulty>1&&G.consWrong>=3){G.consWrong=0;G.difficulty--;}
    if(subject!=='scramble'&&!(G.problem?.type==='mc'))setTimeout(()=>generateProblem(),2000);
    if(G.problem?.type==='mc'||subject==='scramble')setTimeout(()=>generateProblem(),2200);
  }
  updatePlayUI();
}
function updateHighestLevel(){
  const pl=getPlayers();const p=pl[CP.name];
  if(p&&G.difficulty>(p.stats.highestLevel||1)){p.stats.highestLevel=G.difficulty;savePlayers(pl);}
}
function coinPop(amt){
  const d=document.createElement('div');d.className='coin-pop';d.textContent=`+${amt} ü™ô`;
  d.style.left=`${35+Math.random()*35}%`;d.style.top=`${25+Math.random()*20}%`;
  document.body.appendChild(d);setTimeout(()=>d.remove(),1600);
}

// ============================================================
//  SPELLING VOICE
// ============================================================
function speakWord(){
  if(!G.problem||activeGame()!=='spelling'||!('speechSynthesis' in window))return;
  window.speechSynthesis.cancel();
  const word=G.problem.answer;
  const u1=new SpeechSynthesisUtterance(word);applyVoice(u1,G.voiceType);u1.rate=0.62;
  const u2=new SpeechSynthesisUtterance(word);applyVoice(u2,G.voiceType);u2.rate=0.72;
  window.speechSynthesis.speak(u1);
  u1.onend=()=>setTimeout(()=>window.speechSynthesis.speak(u2),600);
}

// ============================================================
//  GOAT
// ============================================================
function goat(){
  const bonus=100;const total=addCoins(CP.name,bonus);
  const pl=getPlayers();const p=pl[CP.name];
  if(p){p.stats.goatCount=(p.stats.goatCount||0)+1;savePlayers(pl);CP=p;}
  document.getElementById('goat-title').textContent=`${CP.name} is the GOAT! üêê`;
  document.getElementById('goat-msg').textContent='Baaaaa! Greatest Of All Time!';
  document.getElementById('goat-coins').textContent=`+${bonus} ü™ô ‚Äî Total: ${total} ü™ô`;
  const p2=getP(CP.name);
  document.getElementById('goat-av').innerHTML=avatarSVG(p2.avatarType||'boy',p2.skinTone||'light',p2.hairColor||HCOLORS.brown,p2.equipped||{},120);
  spawnConfetti();goatSound();showScreen('goat');
}
function keepPlaying(){G.difficulty=1;G.consCorrect=0;G.consWrong=0;generateProblem();showScreen('play');}
function goToHub(){renderHub();showScreen('hub');}
function goatSound(){
  try{const ctx=new(window.AudioContext||window.webkitAudioContext)();
    const o=(f,s,d,t='sine',v=0.3)=>{const o=ctx.createOscillator(),g=ctx.createGain();o.type=t;o.frequency.setValueAtTime(f,ctx.currentTime+s);o.frequency.exponentialRampToValueAtTime(f*.7,ctx.currentTime+s+d*.5);g.gain.setValueAtTime(v,ctx.currentTime+s);g.gain.exponentialRampToValueAtTime(.001,ctx.currentTime+s+d);o.connect(g);g.connect(ctx.destination);o.start(ctx.currentTime+s);o.stop(ctx.currentTime+s+d);};
    o(350,0,.4,'sawtooth',.2);o(280,0,.4,'sawtooth',.15);o(400,.1,.3,'square',.1);o(200,.4,.5,'sawtooth',.2);o(180,.8,.4,'sine',.2);
  }catch(e){}
}
function spawnConfetti(){
  const c=document.getElementById('confetti-c');c.innerHTML='';
  const cols=['#FFD700','#FF6B6B','#4ECDC4','#A78BFA','#F97316','#06D6A0','#FFE66D'];let h='';
  for(let i=0;i<60;i++){const col=cols[Math.floor(Math.random()*cols.length)];const sz=6+Math.random()*10,lft=Math.random()*100,dur=1.5+Math.random()*2,del=Math.random(),rad=Math.random()>.5?'50%':'2px',rot=Math.random()*360;h+=`<div style="position:absolute;left:${lft}%;width:${sz}px;height:${sz}px;background:${col};border-radius:${rad};animation:confettiFall ${dur}s ease-out ${del}s forwards;transform:rotate(${rot}deg)"></div>`;}
  c.innerHTML=h;setTimeout(()=>c.innerHTML='',4000);
}

// ============================================================
//  SHOP
// ============================================================
function renderShop(){
  if(!CP)return;const p=getP(CP.name);
  document.getElementById('shop-coins').textContent=p.coins||0;
  document.getElementById('shop-tabs').innerHTML=Object.entries(SHOP).map(([cat,d])=>
    `<button class="shop-tab ${cat===shopCat?'active':''}" onclick="shopCatSwitch('${cat}')">${d.label}</button>`).join('');
  renderShopItems();
}
function shopCatSwitch(c){shopCat=c;renderShop();}
function renderShopItems(){
  const p=getP(CP.name);const cat=SHOP[shopCat];
  document.getElementById('shop-grid').innerHTML=Object.entries(cat.items).map(([id,item])=>{
    const own=(p.ownedItems||[]).includes(id),eq=p.equipped?.[shopCat]===id,afford=p.coins>=item.price,isG=item.isGoat;
    const badge=eq?`<div class="si-badge si-eq">Equipped</div>`:own?`<div class="si-badge si-owned">Owned</div>`:'';
    const lock=!own&&!afford?`<span style="position:absolute;top:8px;left:8px;opacity:.6">üîí</span>`:'';
    const gstar=isG?`<div class="si-goat">üêê</div>`:'';
    const cls=`shop-item${own?' owned':''}${eq?' equipped':''}${isG?' goat-item':''}${!own&&!afford?' cant-afford':''}`;
    const prev=shopItemPrev(id,shopCat,p);
    return`<div class="${cls}" onclick="shopClick('${id}','${shopCat}')">${badge}${lock}${gstar}
      <div class="preview">${prev}</div>
      <div class="iname">${item.name}</div>
      <div class="iprice">${own?(eq?'‚úì Equipped':'‚úì Owned'):`ü™ô ${item.price}`}</div>
    </div>`;
  }).join('');
}
function shopItemPrev(id,cat,p){const eq={};if(cat)eq[cat]=id;return avatarSVG(p.avatarType||'boy',p.skinTone||'light',p.hairColor||HCOLORS.brown,eq,70);}
function shopClick(id,cat){
  const p=getP(CP.name);const item=SHOP[cat]?.items[id];if(!item)return;
  const own=(p.ownedItems||[]).includes(id);
  if(own){
    const pl=getPlayers();const pp=pl[CP.name];if(!pp.equipped)pp.equipped={};
    pp.equipped[cat]=pp.equipped[cat]===id?null:id;savePlayers(pl);CP=pp;renderShop();renderHub();
  }else{
    if(p.coins<item.price){alert(`Need ${item.price-p.coins} more coins!`);return;}
    if(confirm(`Buy "${item.name}" for ü™ô ${item.price}?`)){
      const pl=getPlayers();const pp=pl[CP.name];pp.coins-=item.price;if(!pp.ownedItems)pp.ownedItems=[];
      pp.ownedItems.push(id);if(!pp.equipped)pp.equipped={};pp.equipped[cat]=id;savePlayers(pl);CP=pp;renderShop();renderHub();
    }
  }
}

// ============================================================
//  AVATAR BUILDER
// ============================================================
function renderBuilder(){
  if(!CP)return;const p=getP(CP.name);builderEq=JSON.parse(JSON.stringify(p.equipped||{}));
  updateBuilderPrev();
  let h=`<div class="b-cat">Skin Tone</div><div class="b-row">${Object.values(SKINS).map(st=>`<div class="b-dot ${p.skinTone===st.id?'active':''}" style="background:${st.color}" onclick="bSkin('${st.id}')"></div>`).join('')}</div>
    <div class="b-cat">Hair Color</div><div class="b-row">${Object.entries(HCOLORS).map(([n,c])=>`<div class="b-hdot ${p.hairColor===c?'active':''}" style="background:${c}" onclick="bHair('${c}')"></div>`).join('')}</div>`;
  for(const[cat,cd]of Object.entries(SHOP)){
    h+=`<div class="b-cat">${cd.label}</div><div class="b-items"><div class="b-chip ${!builderEq[cat]?'active':''}" onclick="bEquip('${cat}',null)">None</div>`;
    for(const[id,item]of Object.entries(cd.items)){const own=(p.ownedItems||[]).includes(id);const act=builderEq[cat]===id;h+=`<div class="b-chip ${act?'active':''} ${!own?'locked':''}" onclick="${own?`bEquip('${cat}','${id}')`:'void(0)'}">${item.emoji} ${item.name}${!own?' üîí':''}</div>`;}
    h+='</div>';
  }
  document.getElementById('builder-controls').innerHTML=h;
}
function bSkin(id){const pl=getPlayers();pl[CP.name].skinTone=id;savePlayers(pl);CP=pl[CP.name];renderBuilder();}
function bHair(c){const pl=getPlayers();pl[CP.name].hairColor=c;savePlayers(pl);CP=pl[CP.name];renderBuilder();}
function bEquip(cat,id){builderEq[cat]=id;renderBuilder();}
function updateBuilderPrev(){const p=getP(CP.name);document.getElementById('builder-preview').innerHTML=avatarSVG(p.avatarType||'boy',p.skinTone||'light',p.hairColor||HCOLORS.brown,builderEq,140);}
function saveAvatar(){const pl=getPlayers();pl[CP.name].equipped={...builderEq};savePlayers(pl);CP=pl[CP.name];renderHub();showScreen('hub');}

// ============================================================
//  STATS
// ============================================================
function renderStats(){
  if(!CP)return;const p=getP(CP.name);const st=p.stats||{};
  const acc=st.totalAttempted>0?Math.round(st.totalCorrect/st.totalAttempted*100):0;
  const gs=st.gradeStats||{};const gst=st.gameStats||{};
  const gRows=[2,3,4,5].map(g=>{const d=gs[g]||{c:0,a:0};const a=d.a>0?Math.round(d.c/d.a*100):0;return d.a>0?`<tr><td>Grade ${g}</td><td>${d.c}/${d.a}</td><td><div>${a}%</div><div class="acc-bar"><div class="acc-fill" style="width:${a}%"></div></div></td></tr>`:''}).filter(Boolean).join('');
  const gmRows=[{k:'math',l:'üî¢ Math'},{k:'spelling',l:'üìù Spelling'},{k:'geography',l:'üåç Geography'},{k:'scramble',l:'üîÄ Word Scramble'}].map(({k,l})=>{const d=gst[k]||{c:0,a:0};const a=d.a>0?Math.round(d.c/d.a*100):0;return`<div class="game-row"><span class="game-row-lbl">${l}</span><span class="game-row-val">${d.c}/${d.a} ‚Äî ${a}%</span></div>`;}).join('');
  document.getElementById('stats-content').innerHTML=`
    <div class="stats-grid">
      <div class="stat-card"><div class="s-val">${st.totalCorrect||0}</div><div class="s-lbl">Total Correct</div></div>
      <div class="stat-card"><div class="s-val">${acc}%</div><div class="s-lbl">Accuracy</div></div>
      <div class="stat-card"><div class="s-val">Lvl ${st.highestLevel||1}</div><div class="s-lbl">Best Level</div></div>
      <div class="stat-card"><div class="s-val">üêê ${st.goatCount||0}</div><div class="s-lbl">GOATs</div></div>
    </div>
    <div class="card" style="margin-top:14px">
      <div style="font-weight:800;margin-bottom:12px">By Game</div>${gmRows||'<p style="color:var(--muted);font-size:.9rem">Play to see stats!</p>'}
    </div>
    <div class="card" style="margin-top:12px">
      <div style="font-weight:800;margin-bottom:12px">By Grade</div>
      ${gRows?`<table class="g-table"><thead><tr><th>Grade</th><th>Correct/Played</th><th>Accuracy</th></tr></thead><tbody>${gRows}</tbody></table>`:'<p style="color:var(--muted);font-size:.9rem">No grades played yet!</p>'}
    </div>
    <div class="card" style="margin-top:12px">
      <div style="font-weight:800;margin-bottom:8px">Coin Wallet ü™ô</div>
      <div style="font-size:2rem;font-weight:900;color:var(--coin)">${p.coins||0} coins</div>
      <div style="color:var(--muted);font-size:.85rem;margin-top:4px">Earn more by playing ‚Äî streaks &amp; level-ups give bonuses!</div>
    </div>`;
}

// ============================================================
//  EVENTS & INIT
// ============================================================
document.getElementById('answer-input').addEventListener('keydown',e=>{if(e.key==='Enter')checkTextAnswer();});
document.getElementById('name-input').addEventListener('keydown',e=>{if(e.key==='Enter')beginNewPlayer();});
if('speechSynthesis' in window){speechSynthesis.onvoiceschanged=()=>speechSynthesis.getVoices();speechSynthesis.getVoices();}
if('serviceWorker' in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
renderWelcome();showScreen('welcome');
</script>
</body>
</html>
