<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Learning Quest">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0F0A2E">
  <title>Learning Quest</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep:#0F0A2E; --bg-mid:#1A1145; --teal:#4ECDC4; --green:#06D6A0;
      --yellow:#FFE66D; --orange:#F97316; --red:#FF6B6B; --purple:#A78BFA;
      --violet:#7C3AED; --white:#ffffff; --muted:rgba(255,255,255,.6);
      --dim:rgba(255,255,255,.3); --glass:rgba(255,255,255,.06);
      --glass-b:rgba(255,255,255,.12); --gold:#FFD700; --coin:#FFC832;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{min-height:100vh;min-height:100dvh;overflow-x:hidden}
    body{
      font-family:'Nunito','Segoe UI',sans-serif;
      background:linear-gradient(145deg,var(--bg-deep) 0%,var(--bg-mid) 40%,#0D1B3E 70%,#071428 100%);
      color:#fff;display:flex;justify-content:center;align-items:flex-start;
      padding:16px;
      padding-top:max(env(safe-area-inset-top),16px);
      padding-bottom:max(env(safe-area-inset-bottom),16px);
    }
    #app{width:100%;max-width:520px}
    .screen{display:none;animation:fadeIn .3s ease}
    .screen.active{display:block}
    @keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

    /* ---- SHARED ---- */
    .logo{text-align:center;margin-bottom:24px}
    .logo h1{font-size:2rem;font-weight:900;background:linear-gradient(135deg,var(--teal),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .logo p{color:var(--muted);font-size:.9rem;margin-top:4px}
    .card{background:var(--glass);border:1px solid var(--glass-b);border-radius:20px;padding:24px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;border-radius:14px;cursor:pointer;font-family:inherit;font-weight:800;font-size:1rem;padding:14px 24px;transition:all .18s;width:100%;margin-top:10px}
    .btn:active{transform:scale(.96)}
    .btn-primary{background:linear-gradient(135deg,var(--teal),var(--violet));color:#fff}
    .btn-secondary{background:var(--glass);border:1px solid var(--glass-b);color:#fff}
    .btn-shop{background:linear-gradient(135deg,var(--gold),var(--orange));color:#1a1a1a}
    .btn-green{background:linear-gradient(135deg,var(--green),var(--teal));color:#fff}
    .btn-sm{padding:10px 18px;font-size:.85rem;border-radius:11px;margin-top:6px}
    .input-field{width:100%;background:var(--glass);border:2px solid var(--glass-b);border-radius:14px;padding:14px 18px;color:#fff;font-family:inherit;font-size:1.1rem;font-weight:700;outline:none;transition:border .2s}
    .input-field:focus{border-color:var(--teal)}
    .input-field::placeholder{color:var(--dim)}
    .section-title{font-size:1.4rem;font-weight:900;text-align:center;margin-bottom:18px}
    .back-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:.9rem;font-family:inherit;padding:8px 0;margin-bottom:16px;display:flex;align-items:center;gap:6px}
    .coin-badge{display:inline-flex;align-items:center;gap:5px;background:rgba(255,200,50,.15);border:1px solid rgba(255,200,50,.3);border-radius:20px;padding:5px 12px;font-weight:800;font-size:.95rem;color:var(--coin)}
    .coin-badge span{font-size:1.1rem}

    /* ---- WELCOME ---- */
    #screen-welcome .welcome-hero{text-align:center;padding:20px 0 30px}
    #screen-welcome .welcome-hero .icon{font-size:4rem;margin-bottom:12px}
    #screen-welcome h2{font-size:1.8rem;font-weight:900;margin-bottom:8px;background:linear-gradient(135deg,var(--yellow),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    #screen-welcome p{color:var(--muted);margin-bottom:24px}
    .player-list{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
    .player-chip{display:flex;align-items:center;justify-content:space-between;background:var(--glass);border:1px solid var(--glass-b);border-radius:14px;padding:12px 16px;cursor:pointer;transition:all .2s}
    .player-chip:hover{border-color:var(--teal);background:rgba(78,205,196,.08)}
    .player-chip .player-info{display:flex;align-items:center;gap:12px}
    .player-chip .player-avatar-mini{width:36px;height:36px;border-radius:50%;overflow:hidden;background:var(--glass)}
    .player-chip .player-name{font-weight:800;font-size:1rem}
    .player-chip .player-meta{font-size:.8rem;color:var(--muted)}
    .player-chip .player-coins{color:var(--coin);font-weight:800;font-size:.9rem}

    /* ---- AVATAR TYPE ---- */
    .avatar-type-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:20px 0}
    .type-card{background:var(--glass);border:2px solid var(--glass-b);border-radius:18px;padding:16px 8px;text-align:center;cursor:pointer;transition:all .2s}
    .type-card:hover,.type-card.selected{border-color:var(--teal);background:rgba(78,205,196,.1)}
    .type-card .type-icon{font-size:2.5rem;margin-bottom:8px}
    .type-card .type-name{font-weight:800;font-size:.95rem}

    /* ---- SKIN TONE ---- */
    .skin-grid{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin:20px 0}
    .skin-swatch{width:56px;height:56px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .2s;position:relative}
    .skin-swatch.selected{border-color:var(--teal);box-shadow:0 0 0 3px rgba(78,205,196,.4)}
    .hair-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:16px 0}
    .hair-swatch{height:36px;border-radius:10px;cursor:pointer;border:2px solid transparent;transition:all .2s}
    .hair-swatch.selected{border-color:var(--teal)}

    /* ---- HUB ---- */
    #screen-hub .hub-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
    .hub-welcome{font-size:1.1rem;font-weight:700}
    .hub-welcome span{color:var(--teal)}
    .hub-avatar-section{display:flex;gap:20px;align-items:center;margin-bottom:24px}
    .hub-avatar-preview{width:110px;height:110px;border-radius:20px;overflow:hidden;background:rgba(255,255,255,.05);border:2px solid var(--glass-b);flex-shrink:0;display:flex;align-items:center;justify-content:center}
    .hub-avatar-preview svg{width:100%;height:100%}
    .hub-stats-mini{flex:1}
    .stat-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--glass-b)}
    .stat-row:last-child{border-bottom:none}
    .stat-label{color:var(--muted);font-size:.85rem}
    .stat-value{font-weight:800;font-size:.95rem}
    .hub-nav{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hub-nav-btn{display:flex;flex-direction:column;align-items:center;gap:8px;background:var(--glass);border:1px solid var(--glass-b);border-radius:18px;padding:18px 10px;cursor:pointer;transition:all .2s;border:none;font-family:inherit;color:#fff}
    .hub-nav-btn:hover{background:rgba(255,255,255,.1)}
    .hub-nav-btn .nav-icon{font-size:1.8rem}
    .hub-nav-btn .nav-label{font-weight:800;font-size:.9rem}
    .hub-nav-btn.play-btn{background:linear-gradient(135deg,rgba(6,214,160,.2),rgba(78,205,196,.2));border:1px solid rgba(78,205,196,.3);grid-column:1/-1}
    .hub-nav-btn.play-btn .nav-label{font-size:1.1rem}

    /* ---- SUBJECT / GRADE / VOICE ---- */
    .choice-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
    .choice-card{background:var(--glass);border:2px solid var(--glass-b);border-radius:18px;padding:20px 12px;text-align:center;cursor:pointer;transition:all .2s}
    .choice-card:hover,.choice-card.selected{border-color:var(--teal);background:rgba(78,205,196,.08)}
    .choice-card .cc-icon{font-size:2.2rem;margin-bottom:10px}
    .choice-card .cc-label{font-weight:800;font-size:1rem}
    .choice-card .cc-sub{color:var(--muted);font-size:.8rem;margin-top:4px}
    .grade-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:16px 0}
    .grade-card{background:var(--glass);border:2px solid var(--glass-b);border-radius:14px;padding:16px 8px;text-align:center;cursor:pointer;transition:all .2s}
    .grade-card:hover{border-color:var(--teal)}

    /* ---- PLAY ---- */
    #screen-play .play-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .play-info{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .badge{display:inline-block;background:var(--glass);border:1px solid var(--glass-b);border-radius:20px;padding:5px 12px;font-size:.8rem;font-weight:700}
    .badge.streak{color:var(--orange)}
    .progress-bar{height:8px;background:var(--glass);border-radius:8px;overflow:hidden;margin-bottom:20px}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--green));border-radius:8px;transition:width .4s ease}
    .question-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:20px;padding:28px 20px;text-align:center;margin-bottom:20px;min-height:140px;display:flex;flex-direction:column;justify-content:center}
    .question-label{color:var(--muted);font-size:.85rem;margin-bottom:12px}
    .question-text{font-size:2.2rem;font-weight:900;line-height:1.2}
    .question-sub{color:var(--muted);font-size:.9rem;margin-top:8px}
    .answer-area{display:flex;gap:10px;margin-bottom:16px}
    .answer-area .input-field{flex:1}
    .answer-area .btn{width:auto;flex-shrink:0;margin:0;padding:14px 20px}
    .feedback{border-radius:14px;padding:12px 16px;text-align:center;font-weight:700;margin-bottom:12px;display:none}
    .feedback.correct{background:rgba(6,214,160,.15);border:1px solid rgba(6,214,160,.3);color:var(--green)}
    .feedback.wrong{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.25);color:var(--red)}
    .hint-text{color:var(--muted);font-size:.9rem;text-align:center;margin-bottom:10px;display:none}
    .coin-popup{position:fixed;pointer-events:none;font-size:1.1rem;font-weight:900;color:var(--coin);text-shadow:0 2px 8px rgba(0,0,0,.5);animation:coinFloat 1.5s ease-out forwards;z-index:999}
    @keyframes coinFloat{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-80px) scale(1.3)}}

    /* ---- GOAT ---- */
    #screen-goat{text-align:center;padding:20px 0}
    .goat-big{font-size:5rem;animation:goatBounce 0.6s ease infinite alternate}
    @keyframes goatBounce{from{transform:scale(1) rotate(-5deg)}to{transform:scale(1.15) rotate(5deg)}}
    .goat-title{font-size:2rem;font-weight:900;margin:16px 0 8px;background:linear-gradient(135deg,var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .goat-msg{color:var(--muted);font-size:1rem;margin-bottom:20px}
    .goat-coins{font-size:1.5rem;font-weight:900;color:var(--coin);margin:16px 0}

    /* ---- SHOP ---- */
    #screen-shop .shop-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .shop-tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:8px;margin-bottom:20px;scrollbar-width:none}
    .shop-tabs::-webkit-scrollbar{display:none}
    .shop-tab{flex-shrink:0;background:var(--glass);border:1px solid var(--glass-b);border-radius:20px;padding:8px 16px;cursor:pointer;font-family:inherit;font-weight:700;font-size:.85rem;color:var(--muted);transition:all .2s}
    .shop-tab.active{background:rgba(78,205,196,.15);border-color:var(--teal);color:#fff}
    .shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .shop-item{background:var(--glass);border:2px solid var(--glass-b);border-radius:18px;padding:16px;text-align:center;position:relative;transition:all .2s;cursor:pointer}
    .shop-item.owned{border-color:rgba(6,214,160,.4)}
    .shop-item.equipped{border-color:var(--teal);background:rgba(78,205,196,.08)}
    .shop-item.goat-item{border-color:rgba(255,215,0,.3);background:rgba(255,215,0,.04)}
    .shop-item .item-preview{height:90px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;border-radius:12px;background:rgba(255,255,255,.04);overflow:hidden}
    .shop-item .item-preview svg{max-height:80px;max-width:80px}
    .shop-item .item-name{font-weight:800;font-size:.9rem;margin-bottom:6px}
    .shop-item .item-price{font-size:.85rem;font-weight:700;color:var(--coin)}
    .shop-item .item-price.free{color:var(--green)}
    .shop-item .owned-badge{position:absolute;top:8px;right:8px;background:rgba(6,214,160,.2);border:1px solid rgba(6,214,160,.4);border-radius:8px;padding:2px 7px;font-size:.7rem;font-weight:800;color:var(--green)}
    .shop-item .equipped-badge{position:absolute;top:8px;right:8px;background:rgba(78,205,196,.25);border:1px solid rgba(78,205,196,.5);border-radius:8px;padding:2px 7px;font-size:.7rem;font-weight:800;color:var(--teal)}
    .shop-item .lock-overlay{position:absolute;top:8px;left:8px;font-size:1rem;opacity:.6}
    .shop-item .goat-star{position:absolute;top:6px;left:8px;font-size:.9rem}
    .cant-afford{opacity:.5}
    .shop-footer{margin-top:20px;padding-top:16px;border-top:1px solid var(--glass-b);text-align:center;color:var(--muted);font-size:.85rem}

    /* ---- AVATAR BUILDER ---- */
    #screen-avatar-builder .builder-layout{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .avatar-preview-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:20px;padding:16px;text-align:center}
    .avatar-preview-card .avatar-svg-wrap{display:flex;justify-content:center;align-items:center;height:200px;margin-bottom:12px}
    .avatar-preview-card .avatar-svg-wrap svg{height:180px;width:auto}
    .builder-controls{display:flex;flex-direction:column;gap:8px}
    .builder-category{font-size:.8rem;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.05em;margin:8px 0 4px}
    .builder-items{display:flex;flex-wrap:wrap;gap:6px}
    .builder-chip{background:var(--glass);border:2px solid var(--glass-b);border-radius:10px;padding:5px 10px;cursor:pointer;font-size:.8rem;font-weight:700;transition:all .15s;white-space:nowrap}
    .builder-chip.active{border-color:var(--teal);color:var(--teal)}
    .builder-chip.locked{opacity:.4;cursor:default}
    .skin-builder-row{display:flex;gap:8px;flex-wrap:wrap}
    .skin-dot{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s;flex-shrink:0}
    .skin-dot.active{border-color:var(--teal);box-shadow:0 0 0 2px rgba(78,205,196,.4)}
    .hair-dot{width:28px;height:18px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all .15s}
    .hair-dot.active{border-color:var(--teal)}

    /* ---- STATS ---- */
    #screen-stats .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:16px 0}
    .stat-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:16px;padding:16px;text-align:center}
    .stat-card .s-value{font-size:1.8rem;font-weight:900;color:var(--teal);margin-bottom:4px}
    .stat-card .s-label{font-size:.8rem;color:var(--muted)}
    .grade-stats-table{width:100%;border-collapse:separate;border-spacing:0 6px;margin-top:16px}
    .grade-stats-table th{color:var(--muted);font-size:.8rem;text-transform:uppercase;letter-spacing:.05em;text-align:left;padding:0 12px 8px}
    .grade-stats-table td{background:var(--glass);padding:10px 12px;font-weight:700;font-size:.9rem}
    .grade-stats-table td:first-child{border-radius:12px 0 0 12px}
    .grade-stats-table td:last-child{border-radius:0 12px 12px 0;color:var(--teal)}
    .accuracy-bar{height:6px;background:rgba(255,255,255,.1);border-radius:6px;overflow:hidden;margin-top:4px}
    .accuracy-fill{height:100%;background:linear-gradient(90deg,var(--teal),var(--green));border-radius:6px}

    /* ---- CONFETTI ---- */
    #confetti-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000;overflow:hidden}
    @keyframes confettiFall{0%{transform:translateY(-20px) rotate(0deg);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}

    /* voice cards */
    .voice-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0}
    .voice-card{background:var(--glass);border:2px solid var(--glass-b);border-radius:16px;padding:16px;text-align:center;cursor:pointer;transition:all .2s}
    .voice-card:hover,.voice-card.selected{border-color:var(--teal);background:rgba(78,205,196,.08)}
    .voice-card .v-icon{font-size:1.8rem;margin-bottom:8px}
    .voice-card .v-name{font-weight:800;font-size:.9rem}
    .voice-card .v-desc{color:var(--muted);font-size:.75rem;margin-top:2px}

    @media(max-width:400px){
      .hub-nav{grid-template-columns:1fr 1fr}
      .shop-grid{grid-template-columns:1fr 1fr}
      #screen-avatar-builder .builder-layout{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div id="app">
  <div id="confetti-container"></div>

  <!-- ===== WELCOME ===== -->
  <div id="screen-welcome" class="screen">
    <div class="welcome-hero">
      <div class="icon">üöÄ</div>
      <h2>Learning Quest</h2>
      <p>Math & Spelling adventures for grades 2‚Äì5</p>
    </div>
    <div id="player-list-section" style="display:none">
      <p style="color:var(--muted);font-size:.85rem;margin-bottom:10px">Welcome back! Pick your hero:</p>
      <div class="player-list" id="player-list"></div>
      <div style="text-align:center;margin:14px 0;color:var(--dim);font-size:.85rem">‚Äî or ‚Äî</div>
    </div>
    <div class="card">
      <p style="font-weight:700;margin-bottom:10px;font-size:.9rem;color:var(--muted)">NEW PLAYER? ENTER YOUR NAME</p>
      <input class="input-field" id="name-input" type="text" placeholder="Your name..." maxlength="20" autocomplete="off">
      <button class="btn btn-primary" onclick="beginNewPlayer()" style="margin-top:14px">‚ú® Start Adventure!</button>
    </div>
  </div>

  <!-- ===== AVATAR TYPE ===== -->
  <div id="screen-avatar-type" class="screen">
    <button class="back-btn" onclick="showScreen('welcome')">‚Üê Back</button>
    <div class="section-title">Choose Your Hero! üéÆ</div>
    <p style="text-align:center;color:var(--muted);margin-bottom:4px;font-size:.9rem">Pick the type of avatar you want</p>
    <div class="avatar-type-grid">
      <div class="type-card" onclick="selectAvatarType('boy')">
        <div class="type-icon">üßí</div>
        <div class="type-name">Boy</div>
      </div>
      <div class="type-card" onclick="selectAvatarType('girl')">
        <div class="type-icon">üëß</div>
        <div class="type-name">Girl</div>
      </div>
      <div class="type-card" onclick="selectAvatarType('explorer')">
        <div class="type-icon">üßë‚ÄçüöÄ</div>
        <div class="type-name">Explorer</div>
      </div>
    </div>
  </div>

  <!-- ===== SKIN + HAIR TONE ===== -->
  <div id="screen-skin-tone" class="screen">
    <button class="back-btn" onclick="showScreen('avatar-type')">‚Üê Back</button>
    <div class="section-title">Customize Your Look ‚ú®</div>
    <div class="card">
      <p style="font-weight:800;margin-bottom:12px">Skin Tone</p>
      <div class="skin-grid" id="skin-grid"></div>
      <p style="font-weight:800;margin:16px 0 12px">Hair Color</p>
      <div class="hair-grid" id="hair-color-grid"></div>
    </div>
    <div style="text-align:center;margin-top:12px">
      <div id="skin-preview" style="display:flex;justify-content:center;margin-bottom:16px"></div>
      <button class="btn btn-primary" onclick="finishAvatarSetup()">Looks Great! Let's Go! üéâ</button>
    </div>
  </div>

  <!-- ===== HUB ===== -->
  <div id="screen-hub" class="screen">
    <div class="hub-header">
      <div>
        <div class="hub-welcome">Hey, <span id="hub-name">Player</span>!</div>
        <div style="color:var(--muted);font-size:.8rem" id="hub-grade-display">Grade ‚Äî</div>
      </div>
      <div class="coin-badge"><span>ü™ô</span> <span id="hub-coins">0</span></div>
    </div>
    <div class="hub-avatar-section">
      <div class="hub-avatar-preview" id="hub-avatar-display"></div>
      <div class="hub-stats-mini">
        <div class="stat-row"><span class="stat-label">Best Level</span><span class="stat-value" id="hub-best-level">‚Äî</span></div>
        <div class="stat-row"><span class="stat-label">Correct</span><span class="stat-value" id="hub-correct">‚Äî</span></div>
        <div class="stat-row"><span class="stat-label">Accuracy</span><span class="stat-value" id="hub-accuracy">‚Äî</span></div>
        <div class="stat-row"><span class="stat-label">GOATs</span><span class="stat-value" id="hub-goats">üêê ‚Äî</span></div>
      </div>
    </div>
    <div class="hub-nav">
      <button class="hub-nav-btn play-btn" onclick="startPlayFlow()">
        <div class="nav-icon">üéÆ</div>
        <div class="nav-label">Play Now!</div>
      </button>
      <button class="hub-nav-btn" onclick="showScreen('shop')">
        <div class="nav-icon">üõí</div>
        <div class="nav-label">Shop</div>
      </button>
      <button class="hub-nav-btn" onclick="showScreen('avatar-builder')">
        <div class="nav-icon">üé®</div>
        <div class="nav-label">Avatar</div>
      </button>
      <button class="hub-nav-btn" onclick="showScreen('stats')">
        <div class="nav-icon">üìä</div>
        <div class="nav-label">Stats</div>
      </button>
    </div>
    <button class="btn btn-secondary" style="margin-top:16px;font-size:.85rem" onclick="switchPlayer()">üîÄ Switch Player</button>
  </div>

  <!-- ===== SUBJECT ===== -->
  <div id="screen-subject" class="screen">
    <button class="back-btn" onclick="showScreen('hub')">‚Üê Hub</button>
    <div class="section-title">What do you want to practice?</div>
    <div class="choice-grid">
      <div class="choice-card" onclick="selectSubject('math')">
        <div class="cc-icon">üî¢</div>
        <div class="cc-label">Math</div>
        <div class="cc-sub">Addition, subtraction, multiply</div>
      </div>
      <div class="choice-card" onclick="selectSubject('spelling')">
        <div class="cc-icon">üìù</div>
        <div class="cc-label">Spelling</div>
        <div class="cc-sub">Hear it, spell it!</div>
      </div>
    </div>
  </div>

  <!-- ===== VOICE ===== -->
  <div id="screen-voice" class="screen">
    <button class="back-btn" onclick="showScreen('subject')">‚Üê Back</button>
    <div class="section-title">Pick a Voice üé§</div>
    <p style="text-align:center;color:var(--muted);font-size:.85rem;margin-bottom:8px">Tap to preview!</p>
    <div class="voice-grid">
      <div class="voice-card" onclick="pickVoice('woman-us')"><div class="v-icon">üë©</div><div class="v-name">American Woman</div><div class="v-desc">US English</div></div>
      <div class="voice-card" onclick="pickVoice('man-us')"><div class="v-icon">üë®</div><div class="v-name">American Man</div><div class="v-desc">US English</div></div>
      <div class="voice-card" onclick="pickVoice('woman-gb')"><div class="v-icon">üë©‚Äçü¶∞</div><div class="v-name">English Woman</div><div class="v-desc">British</div></div>
      <div class="voice-card" onclick="pickVoice('man-gb')"><div class="v-icon">üßî</div><div class="v-name">English Man</div><div class="v-desc">British</div></div>
    </div>
    <button class="btn btn-primary" id="confirm-voice-btn" style="display:none;margin-top:8px" onclick="confirmVoice()">Confirm Voice ‚Üí</button>
  </div>

  <!-- ===== GRADE ===== -->
  <div id="screen-grade" class="screen">
    <button class="back-btn" onclick="goBackFromGrade()">‚Üê Back</button>
    <div class="section-title" id="grade-title">Choose Your Grade</div>
    <div class="grade-grid">
      <div class="grade-card" onclick="startGame(2)"><div style="font-size:1.5rem;margin-bottom:6px">2Ô∏è‚É£</div><div style="font-weight:800">Grade 2</div></div>
      <div class="grade-card" onclick="startGame(3)"><div style="font-size:1.5rem;margin-bottom:6px">3Ô∏è‚É£</div><div style="font-weight:800">Grade 3</div></div>
      <div class="grade-card" onclick="startGame(4)"><div style="font-size:1.5rem;margin-bottom:6px">4Ô∏è‚É£</div><div style="font-weight:800">Grade 4</div></div>
      <div class="grade-card" onclick="startGame(5)"><div style="font-size:1.5rem;margin-bottom:6px">5Ô∏è‚É£</div><div style="font-weight:800">Grade 5</div></div>
    </div>
  </div>

  <!-- ===== PLAY ===== -->
  <div id="screen-play" class="screen">
    <div class="play-header">
      <div class="play-info">
        <span class="badge" id="badge-subject">üìù Spelling</span>
        <span class="badge" id="badge-grade">Grade 2</span>
        <span class="badge" id="badge-level">Level 1</span>
        <span class="badge streak" id="badge-streak" style="display:none">üî• 3</span>
      </div>
      <div class="coin-badge"><span>ü™ô</span><span id="play-coins">0</span></div>
    </div>
    <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    <div class="question-card">
      <div class="question-label" id="question-label">Spell this word:</div>
      <div class="question-text" id="question-text">‚Äî</div>
      <div class="question-sub" id="question-sub"></div>
    </div>
    <div id="feedback" class="feedback"></div>
    <div class="hint-text" id="hint-text"></div>
    <div class="answer-area">
      <input class="input-field" id="answer-input" type="text" placeholder="Your answer..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
      <button class="btn btn-green" style="width:auto;margin:0" onclick="checkAnswer()">‚úì</button>
    </div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-secondary btn-sm" onclick="repeatWord()" id="repeat-btn" style="display:none">üîä Repeat</button>
      <button class="btn btn-secondary btn-sm" onclick="goToHub()">üè† Hub</button>
    </div>
  </div>

  <!-- ===== GOAT ===== -->
  <div id="screen-goat" class="screen">
    <div class="goat-big" id="goat-emoji">üêê</div>
    <div class="goat-title" id="goat-title">GOAT!</div>
    <div class="goat-msg" id="goat-msg">You are the Greatest of All Time!</div>
    <div class="goat-coins" id="goat-coins">+100 ü™ô</div>
    <div id="goat-avatar-display" style="display:flex;justify-content:center;margin:16px 0"></div>
    <button class="btn btn-primary" onclick="keepPlaying()">Keep Going! üöÄ</button>
    <button class="btn btn-secondary" onclick="goToHub()" style="margin-top:8px">Back to Hub üè†</button>
  </div>

  <!-- ===== SHOP ===== -->
  <div id="screen-shop" class="screen">
    <button class="back-btn" onclick="showScreen('hub')">‚Üê Hub</button>
    <div class="shop-header">
      <div style="font-size:1.2rem;font-weight:900">üõí Shop</div>
      <div class="coin-badge"><span>ü™ô</span><span id="shop-coins">0</span></div>
    </div>
    <div class="shop-tabs" id="shop-tabs"></div>
    <div class="shop-grid" id="shop-grid"></div>
    <div class="shop-footer">Earn coins by answering correctly! Streaks & level-ups give bonuses.</div>
  </div>

  <!-- ===== AVATAR BUILDER ===== -->
  <div id="screen-avatar-builder" class="screen">
    <button class="back-btn" onclick="showScreen('hub')">‚Üê Hub</button>
    <div class="section-title">üé® Avatar Builder</div>
    <div class="builder-layout" id="builder-layout">
      <div class="avatar-preview-card">
        <div class="avatar-svg-wrap" id="builder-avatar-preview"></div>
        <div style="font-size:.8rem;color:var(--muted);text-align:center">Your Avatar</div>
      </div>
      <div class="builder-controls" id="builder-controls"></div>
    </div>
    <button class="btn btn-green" style="margin-top:16px" onclick="saveAvatar()">üíæ Save Avatar</button>
  </div>

  <!-- ===== STATS ===== -->
  <div id="screen-stats" class="screen">
    <button class="back-btn" onclick="showScreen('hub')">‚Üê Hub</button>
    <div class="section-title">üìä Your Stats</div>
    <div id="stats-content"></div>
  </div>

</div>

<script>
// =====================================================
//  DATA
// =====================================================
const SKIN_TONES = {
  light:   { id:'light',   color:'#FDDBB4', shadow:'#D4956A', name:'Light' },
  medium:  { id:'medium',  color:'#D4956A', shadow:'#B07040', name:'Medium'},
  dark:    { id:'dark',    color:'#8B5C2A', shadow:'#5C3A10', name:'Dark'  },
  fantasy: { id:'fantasy', color:'#B8E0FF', shadow:'#7EB8E8', name:'Blue'  },
};
const HAIR_COLORS = {
  brown:  '#5C3A1E',
  black:  '#1a1a2a',
  blonde: '#C8860A',
  red:    '#A02020',
  purple: '#6A20A0',
  teal:   '#1A9090',
};

// Shop & Avatar Items
const SHOP_ITEMS = {
  hair: {
    label:'‚úÇÔ∏è Hair',
    items: {
      hair_curly:   { name:'Curly Cloud',      price:100,  emoji:'üåÄ' },
      hair_mohawk:  { name:'Wild Mohawk',       price:200,  emoji:'‚ö°' },
      hair_long:    { name:'Flowing Locks',     price:150,  emoji:'üåä' },
      hair_rainbow: { name:'Rainbow Dreads',    price:500,  emoji:'üåà' },
    }
  },
  outfit: {
    label:'üëï Outfits',
    items: {
      outfit_sporty: { name:'Sporty Jersey',    price:75,   emoji:'üèÜ' },
      outfit_wizard: { name:'Wizard Robes',     price:200,  emoji:'üîÆ' },
      outfit_dragon: { name:'Dragon Armor',     price:450,  emoji:'üêâ' },
      outfit_goat:   { name:'GOAT Robe',        price:900,  emoji:'üêê', isGoat:true },
    }
  },
  hat: {
    label:'üé© Hats',
    items: {
      hat_cap:        { name:'Baseball Cap',    price:60,   emoji:'üß¢' },
      hat_wizard:     { name:'Wizard Hat',      price:150,  emoji:'üé©' },
      hat_crown:      { name:'Party Crown',     price:300,  emoji:'üëë' },
      hat_goat_crown: { name:'GOAT Crown',      price:750,  emoji:'üêê', isGoat:true },
    }
  },
  accessory: {
    label:'üï∂Ô∏è Accessories',
    items: {
      acc_shades:  { name:'Cool Shades',        price:80,   emoji:'üï∂Ô∏è' },
      acc_cape:    { name:'Hero Cape',          price:250,  emoji:'ü¶∏' },
      acc_rocket:  { name:'Rocket Pack',        price:500,  emoji:'üöÄ' },
      acc_goat_halo: { name:'GOAT Halo',        price:999,  emoji:'üêê', isGoat:true },
    }
  },
  background: {
    label:'üåå Background',
    items: {
      bg_stars:   { name:'Starfield',           price:100,  emoji:'‚≠ê' },
      bg_rainbow: { name:'Rainbow Sky',         price:200,  emoji:'üåà' },
      bg_fire:    { name:'Fire Arena',          price:400,  emoji:'üî•' },
      bg_goat_meadow: { name:'GOAT Meadow',     price:600,  emoji:'üêê', isGoat:true },
    }
  }
};

const SLOT_CATEGORIES = {
  hair:       'hair',
  outfit:     'outfit',
  hat:        'hat',
  accessory:  'accessory',
  background: 'background'
};

// Map item IDs to their slot
function getItemSlot(itemId) {
  for (const [cat, data] of Object.entries(SHOP_ITEMS)) {
    if (data.items[itemId]) return cat;
  }
  return null;
}

// =====================================================
//  WORD BANKS
// =====================================================
const WORDS = {
  2:{
    1:['cat','dog','run','big','sun','hat','bed','map','cup','leg','pig','top','red','box','fun'],
    2:['jump','play','stop','fish','tree','frog','milk','duck','wish','king','drum','ship','nest','pink','lamp'],
    3:['happy','green','sleep','black','brown','plant','three','white','small','bring','drink','smile','float','chair','stone'],
    4:['friend','should','please','school','people','around','before','twelve','change','follow','pretty','always','animal','father','mother'],
    5:['because','through','thought','brother','another','morning','nothing','tonight','outside','picture','between','hundred','kitchen','blanket','mittens'],
  },
  3:{
    1:['lake','home','time','five','give','come','some','bone','note','fire','more','side','wide','hope','ride'],
    2:['begin','study','water','never','after','story','every','again','world','write','start','laugh','power','guess','quiet'],
    3:['beauty','center','simple','circle','listen','castle','garden','orange','planet','silver','street','bridge','finger','basket','ladder'],
    4:['trouble','country','weather','journey','already','evening','against','certain','million','special','library','mystery','harvest','balance','captain'],
    5:['discover','mountain','powerful','exercise','together','southern','daughter','children','complete','although','practice','question','probably','sentence','whatever'],
  },
  4:{
    1:['code','free','game','huge','race','save','tide','zone','brave','crane','grace','prime','quote','ridge','theme'],
    2:['adapt','brave','cease','defer','eager','feast','groan','haste','ideal','joust','knack','lapse','manor','niece','onset'],
    3:['absence','ancient','bracket','channel','citizen','damage','edition','fashion','gesture','horizon','illusion','journey','kitchen','leisure','mixture'],
    4:['accident','audience','beneath','calendar','champion','decrease','division','enormous','fraction','generous','humidity','identify','jealousy','keyboard','likewise'],
    5:['abandoned','ambitious','beautiful','calculate','dangerous','efficient','elaborate','fantastic','gradually','happiness','immediate','knowledge','language','necessary','obviously'],
  },
  5:{
    1:['achieve','acquire','address','advance','benefit','capture','decline','defense','elegant','failure','genuine','hostile','inspire','justice','kingdom'],
    2:['absolute','accurate','addition','adhesive','adjacent','admirable','affection','aggression','agitation','alignment','alliance','altitude','amazement','amendment','ambition'],
    3:['accelerate','accomplish','according','accumulate','adjustment','admiration','advantage','adventure','affliction','affordable','aggressive','allegiance','allocation','allowance','ambiguous'],
    4:['abbreviate','abnormally','abruptness','absolutely','absorption','abstinence','abundance','accelerate','accessible','accomplish','accordance','accountable','accumulate','accurately','achievement'],
    5:['abandonment','abbreviation','abomination','accomplishment','accountability','acknowledgment','administration','advertisement','affectionate','aggravation','agricultural','alliteration','ameliorate','amplification','anticipation'],
  }
};

// =====================================================
//  GAME STATE
// =====================================================
let state = {
  playerName: '',
  subject: '',
  grade: 2,
  difficulty: 1,
  streak: 0,
  consecutiveCorrect: 0,
  consecutiveWrong: 0,
  totalCorrect: 0,
  totalAttempted: 0,
  usedWords: {},
  problem: null,
  voiceType: 'woman-us',
};

// =====================================================
//  PLAYER DATA (localStorage)
// =====================================================
function getPlayers() {
  try { return JSON.parse(localStorage.getItem('lq_players') || '{}'); } catch(e){ return {}; }
}
function savePlayers(p) { localStorage.setItem('lq_players', JSON.stringify(p)); }

function getPlayer(name) {
  const players = getPlayers();
  return players[name] || null;
}

function createPlayer(name, avatarType, skinTone, hairColor) {
  const players = getPlayers();
  players[name] = {
    name,
    avatarType,
    skinTone,
    hairColor,
    coins: 0,
    ownedItems: [],
    equipped: { hair: null, outfit: null, hat: null, accessory: null, background: null },
    stats: {
      totalCorrect: 0,
      totalAttempted: 0,
      highestLevel: 1,
      goatCount: 0,
      gradeStats: { 2:{correct:0,attempted:0}, 3:{correct:0,attempted:0}, 4:{correct:0,attempted:0}, 5:{correct:0,attempted:0} }
    }
  };
  savePlayers(players);
  return players[name];
}

function updatePlayer(name, updates) {
  const players = getPlayers();
  if (!players[name]) return;
  Object.assign(players[name], updates);
  savePlayers(players);
}

function addCoins(name, amount) {
  const players = getPlayers();
  if (!players[name]) return;
  players[name].coins = (players[name].coins || 0) + amount;
  savePlayers(players);
  return players[name].coins;
}

// =====================================================
//  CURRENT PLAYER STATE
// =====================================================
let currentPlayer = null;
let tempAvatarSetup = { avatarType:'boy', skinTone:'light', hairColor:'brown' };
let builderEquipped = null;

function loadCurrentPlayer(name) {
  currentPlayer = getPlayer(name);
  state.playerName = name;
  return currentPlayer;
}

// =====================================================
//  SVG AVATAR GENERATION
// =====================================================
function generateAvatarSVG(avatarType, skinToneId, hairColorHex, equipped, size) {
  const st = SKIN_TONES[skinToneId] || SKIN_TONES.light;
  const skin = st.color;
  const shadow = st.shadow;
  const hair = hairColorHex || HAIR_COLORS.brown;
  const eq = equipped || {};

  let bg = getBg(eq.background, size);
  let bodyLayer = getOutfitSVG(eq.outfit, skin);
  let hairBack = getHairBack(eq.hair || 'hair_default', hair, avatarType);
  let headLayer = `<circle cx="100" cy="95" r="58" fill="${skin}"/>`;
  let faceLayer = getFace(skin, shadow, avatarType);
  let hairFront = getHairFront(eq.hair || 'hair_default', hair, avatarType);
  let hatLayer = eq.hat ? getHatSVG(eq.hat) : '';
  let accLayer = getAccessorySVG(eq.accessory, skin);

  const w = size || 200;
  const h = size ? Math.round(size * 1.4) : 280;

  return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 280" width="${w}" height="${h}">
    ${bg}
    ${accLayer.back || ''}
    ${bodyLayer}
    <rect x="83" y="148" width="34" height="26" fill="${skin}" rx="6"/>
    ${hairBack}
    ${headLayer}
    ${faceLayer}
    ${hairFront}
    ${hatLayer}
    ${accLayer.front || ''}
  </svg>`;
}

function getBg(bgId, size) {
  switch(bgId) {
    case 'bg_stars': return `
      <rect width="200" height="280" fill="#0a0820"/>
      <circle cx="30" cy="20" r="1.5" fill="white" opacity=".8"/>
      <circle cx="80" cy="35" r="1" fill="white" opacity=".6"/>
      <circle cx="150" cy="15" r="2" fill="white" opacity=".9"/>
      <circle cx="170" cy="50" r="1" fill="white" opacity=".7"/>
      <circle cx="20" cy="70" r="1.5" fill="white" opacity=".5"/>
      <circle cx="185" cy="90" r="1" fill="white" opacity=".8"/>
      <circle cx="60" cy="250" r="1" fill="white" opacity=".4"/>
      <circle cx="140" cy="260" r="1.5" fill="white" opacity=".6"/>`;
    case 'bg_rainbow': return `
      <defs>
        <linearGradient id="rg" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#FF8080"/><stop offset="30%" stop-color="#FFCC80"/>
          <stop offset="60%" stop-color="#80CCFF"/><stop offset="100%" stop-color="#C080FF"/>
        </linearGradient>
      </defs>
      <rect width="200" height="280" fill="url(#rg)"/>
      <circle cx="100" cy="280" r="200" fill="none" stroke="rgba(255,255,255,.15)" stroke-width="20"/>
      <circle cx="100" cy="280" r="175" fill="none" stroke="rgba(255,255,255,.1)" stroke-width="15"/>`;
    case 'bg_fire': return `
      <defs>
        <linearGradient id="fg" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#FF4500"/><stop offset="50%" stop-color="#FF8C00"/>
          <stop offset="100%" stop-color="#FFD700"/>
        </linearGradient>
      </defs>
      <rect width="200" height="280" fill="url(#fg)"/>
      <path d="M0 280 Q25 220 50 250 Q75 200 100 230 Q125 195 150 240 Q175 210 200 260 L200 280Z" fill="rgba(255,100,0,.3)"/>`;
    case 'bg_goat_meadow': return `
      <defs>
        <linearGradient id="mg" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="#87CEEB"/><stop offset="60%" stop-color="#98FB98"/>
          <stop offset="100%" stop-color="#228B22"/>
        </linearGradient>
      </defs>
      <rect width="200" height="280" fill="url(#mg)"/>
      <text x="15" y="30" font-size="16">üêê</text>
      <text x="155" y="45" font-size="12">‚≠ê</text>
      <text x="10" y="260" font-size="10">üå∏</text>
      <text x="170" y="270" font-size="10">üåº</text>
      <ellipse cx="100" cy="280" rx="100" ry="30" fill="#1a6b1a" opacity=".5"/>`;
    default: return `
      <defs>
        <linearGradient id="dg" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" stop-color="#1a0a3e"/><stop offset="100%" stop-color="#0d1b3e"/>
        </linearGradient>
      </defs>
      <rect width="200" height="280" fill="url(#dg)"/>`;
  }
}

function getOutfitSVG(outfitId, skin) {
  const baseBody = (fill, detail='') => `
    <path d="M25 180 L45 165 Q65 158 100 156 Q135 158 155 165 L175 180 L175 280 L25 280 Z" fill="${fill}"/>
    <path d="M80 156 Q100 168 120 156" fill="none" stroke="${skin}" stroke-width="8" stroke-linecap="round"/>
    ${detail}`;
  switch(outfitId) {
    case 'outfit_sporty': return baseBody('#2244AA',
      `<rect x="25" y="195" width="150" height="8" fill="rgba(255,255,255,.25)"/>
       <rect x="25" y="210" width="150" height="5" fill="rgba(255,255,255,.15)"/>
       <text x="80" y="250" font-size="22" font-weight="bold" fill="rgba(255,255,255,.8)">1</text>`);
    case 'outfit_wizard': return baseBody('#6B21A8',
      `<path d="M25 180 L45 165 Q65 158 100 156 Q135 158 155 165 L175 180 L175 280 L25 280 Z" fill="#6B21A8"/>
       <circle cx="60" cy="200" r="5" fill="rgba(255,220,50,.6)"/>
       <circle cx="140" cy="215" r="4" fill="rgba(255,220,50,.5)"/>
       <circle cx="90" cy="240" r="6" fill="rgba(255,220,50,.7)"/>
       <path d="M40 185 Q45 178 50 185" fill="none" stroke="rgba(255,220,50,.5)" stroke-width="2"/>
       <path d="M148 225 Q153 218 158 225" fill="none" stroke="rgba(255,220,50,.5)" stroke-width="2"/>`);
    case 'outfit_dragon': return baseBody('#DC2626',
      `<path d="M25 180 Q35 170 45 175 L45 280 L25 280Z" fill="#B91C1C"/>
       <path d="M155 175 Q165 170 175 180 L175 280 L155 280Z" fill="#B91C1C"/>
       <path d="M45 180 Q70 170 100 168 Q130 170 155 180" fill="none" stroke="rgba(255,255,255,.3)" stroke-width="2"/>
       <path d="M30 200 Q100 190 170 200" fill="none" stroke="#FCD34D" stroke-width="1.5" opacity=".6"/>
       <path d="M30 220 Q100 210 170 220" fill="none" stroke="#FCD34D" stroke-width="1.5" opacity=".4"/>
       <text x="82" y="255" font-size="20">üî•</text>`);
    case 'outfit_goat': return `
      <path d="M25 180 L45 165 Q65 158 100 156 Q135 158 155 165 L175 180 L175 280 L25 280 Z" fill="#F5D060"/>
      <path d="M80 156 Q100 168 120 156" fill="none" stroke="${skin}" stroke-width="8" stroke-linecap="round"/>
      <path d="M25 180 L45 165 Q65 158 100 156 Q135 158 155 165 L175 180" fill="none" stroke="#C9AA38" stroke-width="3"/>
      <path d="M40 210 Q100 205 160 210" fill="none" stroke="#C9AA38" stroke-width="1.5" opacity=".6"/>
      <text x="72" y="240" font-size="28">üêê</text>
      <text x="110" y="245" font-size="14">üëë</text>`;
    default: return baseBody('#3B82F6');
  }
}

function getHairBack(hairId, color, avatarType) {
  switch(hairId) {
    case 'hair_long': return `
      <rect x="36" y="88" width="22" height="95" rx="11" fill="${color}"/>
      <rect x="142" y="88" width="22" height="95" rx="11" fill="${color}"/>`;
    case 'hair_rainbow': return `
      <rect x="34" y="88" width="16" height="110" rx="8" fill="#FF6B6B"/>
      <rect x="54" y="88" width="16" height="105" rx="8" fill="#FFB347"/>
      <rect x="130" y="88" width="16" height="108" rx="8" fill="#82CA9D"/>
      <rect x="150" y="88" width="16" height="112" rx="8" fill="#87CEEB"/>`;
    default: return '';
  }
}

function getFace(skin, shadow, avatarType) {
  // Nose
  const nose = `<path d="M96 112 Q100 119 104 112" fill="none" stroke="${shadow}" stroke-width="2" stroke-linecap="round" opacity=".7"/>`;
  // Eyes
  let eyes = '';
  if(avatarType === 'girl') {
    eyes = `
      <ellipse cx="78" cy="96" rx="13" ry="14" fill="white"/>
      <ellipse cx="122" cy="96" rx="13" ry="14" fill="white"/>
      <circle cx="80" cy="97" r="9" fill="#2C1810"/>
      <circle cx="124" cy="97" r="9" fill="#2C1810"/>
      <circle cx="83" cy="94" r="3.5" fill="white"/>
      <circle cx="127" cy="94" r="3.5" fill="white"/>
      <line x1="68" y1="84" x2="63" y2="78" stroke="#2C1810" stroke-width="1.8"/>
      <line x1="75" y1="82" x2="73" y2="76" stroke="#2C1810" stroke-width="1.8"/>
      <line x1="82" y1="82" x2="83" y2="76" stroke="#2C1810" stroke-width="1.8"/>
      <line x1="88" y1="83" x2="91" y2="78" stroke="#2C1810" stroke-width="1.8"/>
      <line x1="112" y1="83" x2="109" y2="78" stroke="#2C1810" stroke-width="1.8"/>
      <line x1="118" y1="82" x2="117" y2="76" stroke="#2C1810" stroke-width="1.8"/>
      <line x1="125" y1="82" x2="127" y2="76" stroke="#2C1810" stroke-width="1.8"/>
      <line x1="132" y1="83" x2="135" y2="78" stroke="#2C1810" stroke-width="1.8"/>
      <ellipse cx="68" cy="104" rx="6" ry="3" fill="rgba(220,120,120,.3)"/>
      <ellipse cx="132" cy="104" rx="6" ry="3" fill="rgba(220,120,120,.3)"/>`;
  } else if(avatarType === 'explorer') {
    eyes = `
      <ellipse cx="78" cy="97" rx="12" ry="11" fill="white"/>
      <ellipse cx="122" cy="97" rx="12" ry="11" fill="white"/>
      <circle cx="80" cy="98" r="8" fill="#1a2a4a"/>
      <circle cx="124" cy="98" r="8" fill="#1a2a4a"/>
      <circle cx="83" cy="95" r="3" fill="white"/>
      <circle cx="127" cy="95" r="3" fill="white"/>
      <line x1="66" y1="87" x2="90" y2="87" stroke="#2C1810" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="110" y1="87" x2="134" y2="87" stroke="#2C1810" stroke-width="2.5" stroke-linecap="round"/>`;
  } else {
    eyes = `
      <ellipse cx="78" cy="97" rx="12" ry="13" fill="white"/>
      <ellipse cx="122" cy="97" rx="12" ry="13" fill="white"/>
      <circle cx="80" cy="98" r="8.5" fill="#2C1810"/>
      <circle cx="124" cy="98" r="8.5" fill="#2C1810"/>
      <circle cx="83" cy="95" r="3" fill="white"/>
      <circle cx="127" cy="95" r="3" fill="white"/>`;
  }
  // Mouth
  const mouth = `<path d="M82 122 Q100 136 118 122" fill="none" stroke="#C07860" stroke-width="3.5" stroke-linecap="round"/>
    <path d="M84 124 Q100 134 116 124" fill="rgba(220,120,100,.3)"/>`;
  // Ears
  const ears = `
    <ellipse cx="41" cy="98" rx="8" ry="10" fill="${skin}"/>
    <ellipse cx="41" cy="98" rx="5" ry="7" fill="${shadow}" opacity=".3"/>
    <ellipse cx="159" cy="98" rx="8" ry="10" fill="${skin}"/>
    <ellipse cx="159" cy="98" rx="5" ry="7" fill="${shadow}" opacity=".3"/>`;
  return ears + nose + eyes + mouth;
}

function getHairFront(hairId, color, avatarType) {
  const defaultBoy = `<path d="M42 93 Q42 30 100 30 Q158 30 158 93 Q150 60 100 58 Q50 60 42 93Z" fill="${color}"/>`;
  const defaultGirl = `<path d="M42 96 Q42 28 100 28 Q158 28 158 96 Q152 62 100 60 Q48 62 42 96Z" fill="${color}"/>
    <path d="M42 96 Q38 80 42 65 Q45 50 55 42" fill="none" stroke="${color}" stroke-width="16" stroke-linecap="round"/>`;
  const defaultExplorer = `<path d="M42 90 Q44 28 100 26 Q156 28 158 90 Q150 58 100 56 Q50 58 42 90Z" fill="${color}"/>
    <path d="M42 85 Q33 73 42 58" fill="none" stroke="${color}" stroke-width="14" stroke-linecap="round"/>`;

  switch(hairId) {
    case 'hair_default':
      return avatarType==='girl' ? defaultGirl : avatarType==='explorer' ? defaultExplorer : defaultBoy;
    case 'hair_curly': return `
      <circle cx="52" cy="55" r="18" fill="${color}"/>
      <circle cx="70" cy="38" r="16" fill="${color}"/>
      <circle cx="100" cy="32" r="20" fill="${color}"/>
      <circle cx="130" cy="38" r="16" fill="${color}"/>
      <circle cx="148" cy="55" r="18" fill="${color}"/>
      <circle cx="42" cy="75" r="14" fill="${color}"/>
      <circle cx="158" cy="75" r="14" fill="${color}"/>`;
    case 'hair_mohawk': return `
      <path d="M42 92 Q42 80 60 95 Q70 70 80 90 Q90 50 100 30 Q110 50 120 90 Q130 70 140 95 Q158 80 158 92 Q148 68 100 58 Q52 68 42 92Z" fill="${color}"/>
      <path d="M85 75 Q100 25 115 75" fill="${color}" opacity=".8"/>`;
    case 'hair_long': return `
      <path d="M42 94 Q42 30 100 28 Q158 30 158 94 Q152 62 100 60 Q48 62 42 94Z" fill="${color}"/>`;
    case 'hair_rainbow': return `
      <path d="M42 94 Q42 30 100 28 Q158 30 158 94 Q152 62 100 60 Q48 62 42 94Z" fill="${color}"/>
      <path d="M44 88 Q44 35 100 32 Q156 35 156 88" fill="none" stroke="#FF6B6B" stroke-width="5" opacity=".6"/>
      <path d="M47 82 Q47 40 100 36" fill="none" stroke="#FFB347" stroke-width="4" opacity=".5"/>`;
    default:
      return avatarType==='girl' ? defaultGirl : defaultBoy;
  }
}

function getHatSVG(hatId) {
  switch(hatId) {
    case 'hat_cap': return `
      <rect x="58" y="52" width="84" height="28" rx="6" fill="#1a4a8a"/>
      <rect x="45" y="74" width="110" height="14" rx="5" fill="#1a3a6a"/>
      <rect x="45" y="74" width="110" height="6" rx="3" fill="#2255AA"/>
      <ellipse cx="100" cy="55" rx="10" ry="4" fill="#1a3a6a"/>`;
    case 'hat_wizard': return `
      <path d="M100 -5 L70 72 L130 72 Z" fill="#6B21A8"/>
      <ellipse cx="100" cy="72" rx="38" ry="12" fill="#7C3AED"/>
      <path d="M100 -5 L72 70" fill="none" stroke="rgba(255,220,50,.5)" stroke-width="2"/>
      <circle cx="100" cy="15" r="5" fill="#FFD700"/>
      <path d="M75 50 Q80 44 85 50" fill="none" stroke="#FFD700" stroke-width="1.5" opacity=".7"/>`;
    case 'hat_crown': return `
      <path d="M65 75 L65 50 L82 65 L100 42 L118 65 L135 50 L135 75 Z" fill="#FFD700"/>
      <rect x="63" y="73" width="74" height="16" rx="5" fill="#FFC107"/>
      <circle cx="65" cy="51" r="5" fill="#FF4444"/>
      <circle cx="100" cy="44" r="6" fill="#4444FF"/>
      <circle cx="135" cy="51" r="5" fill="#44FF44"/>
      <circle cx="82" cy="65" r="4" fill="#FF44FF"/>
      <circle cx="118" cy="65" r="4" fill="#FF8800"/>`;
    case 'hat_goat_crown': return `
      <path d="M65 75 L65 45 L82 62 L100 38 L118 62 L135 45 L135 75 Z" fill="#FFD700"/>
      <rect x="62" y="73" width="76" height="18" rx="6" fill="#FFC107"/>
      <circle cx="100" cy="40" r="7" fill="#FF4444"/>
      <circle cx="68" cy="47" r="5" fill="#4444FF"/>
      <circle cx="132" cy="47" r="5" fill="#44FF44"/>
      <text x="84" y="92" font-size="13" font-weight="bold" fill="#7a3500">üêê</text>
      <path d="M90 50 Q95 46 100 50" fill="none" stroke="rgba(255,255,255,.7)" stroke-width="1.5"/>
      <circle cx="82" cy="63" r="4" fill="#FF8800"/>
      <circle cx="118" cy="63" r="4" fill="#CC00CC"/>`;
    default: return '';
  }
}

function getAccessorySVG(accId, skin) {
  switch(accId) {
    case 'acc_shades': return {
      front: `<rect x="62" y="91" width="30" height="18" rx="7" fill="#1a1a2a"/>
        <rect x="108" y="91" width="30" height="18" rx="7" fill="#1a1a2a"/>
        <rect x="90" y="96" width="20" height="4" rx="2" fill="#333"/>
        <rect x="48" y="96" width="15" height="4" rx="2" fill="#555"/>
        <rect x="137" y="96" width="15" height="4" rx="2" fill="#555"/>
        <rect x="64" y="93" width="26" height="14" rx="6" fill="#2255CC" opacity=".6"/>
        <rect x="110" y="93" width="26" height="14" rx="6" fill="#2255CC" opacity=".6"/>`,
      back: ''
    };
    case 'acc_cape': return {
      back: `<path d="M55 165 Q40 190 35 280 L55 280 Q70 220 100 210 Q130 220 145 280 L165 280 Q160 190 145 165Z" fill="#DC2626" opacity=".9"/>
        <path d="M55 165 Q70 170 100 168 Q130 170 145 165" fill="none" stroke="#FFD700" stroke-width="3"/>`,
      front: ''
    };
    case 'acc_rocket': return {
      back: `<rect x="155" y="155" width="22" height="45" rx="8" fill="#9CA3AF"/>
        <path d="M155 155 Q166 135 177 155Z" fill="#EF4444"/>
        <rect x="152" y="185" width="8" height="14" rx="3" fill="#6B7280"/>
        <rect x="177" y="185" width="8" height="14" rx="3" fill="#6B7280"/>
        <path d="M155 200 Q160 215 165 200" fill="#FB923C" opacity=".8"/>
        <path d="M162 200 Q166 220 170 200" fill="#FBBF24" opacity=".6"/>`,
      front: ''
    };
    case 'acc_goat_halo': return {
      front: `<ellipse cx="100" cy="18" rx="36" ry="10" fill="none" stroke="#FFD700" stroke-width="5"/>
        <ellipse cx="100" cy="18" rx="36" ry="10" fill="none" stroke="rgba(255,255,255,.4)" stroke-width="2"/>
        <text x="84" y="8" font-size="12">üêê</text>`,
      back: ''
    };
    default: return { front:'', back:'' };
  }
}

// =====================================================
//  MATH PROBLEM GENERATION
// =====================================================
function generateMathProblem(grade, difficulty) {
  const rand = (a,b) => Math.floor(Math.random()*(b-a+1))+a;
  let a,b,op,q,ans;
  if(grade <= 2) {
    if(difficulty <= 2) { a=rand(1,20); b=rand(1,20-a); op='+'; ans=a+b; }
    else if(difficulty <= 4) {
      const r=rand(0,1);
      if(r===0){ a=rand(5,20);b=rand(1,a);op='-';ans=a-b; }
      else { a=rand(1,10);b=rand(2,5);op='√ó';ans=a*b; }
    } else { a=rand(2,10);b=rand(2,5);op='√ó';ans=a*b; }
  } else if(grade === 3) {
    if(difficulty<=2){a=rand(10,99);b=rand(10,99);op='+';ans=a+b;}
    else if(difficulty<=4){const r=rand(0,2);if(r===0){a=rand(20,99);b=rand(10,a);op='-';ans=a-b;}else if(r===1){a=rand(2,12);b=rand(2,12);op='√ó';ans=a*b;}else{a=rand(2,9);b=rand(1,a);op='√∑';ans=Math.floor(a*b/b);const tmp=a*b;a=tmp;}}
    else{a=rand(4,12);b=rand(4,12);op='√ó';ans=a*b;}
  } else if(grade === 4) {
    if(difficulty<=2){a=rand(10,99);b=rand(10,99);op='√ó';ans=a*b;}
    else{a=rand(12,99);b=rand(2,9);op='√∑';const r=a*b;a=r;ans=a/b;}
  } else {
    if(difficulty<=2){a=rand(100,999);b=rand(100,999);op='+';ans=a+b;}
    else{a=rand(12,99);b=rand(12,99);op='√ó';ans=a*b;}
  }
  q=`${a} ${op} ${b} = ?`;
  return {question:q, answer:String(ans)};
}

// =====================================================
//  SCREEN NAVIGATION
// =====================================================
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById('screen-'+name);
  if(el){ el.classList.add('active'); window.scrollTo(0,0); }
}

// =====================================================
//  WELCOME SCREEN
// =====================================================
function renderWelcome() {
  const players = getPlayers();
  const names = Object.keys(players);
  const listSection = document.getElementById('player-list-section');
  const list = document.getElementById('player-list');
  if(names.length > 0) {
    listSection.style.display = 'block';
    list.innerHTML = names.map(n => {
      const p = players[n];
      const mini = generateAvatarSVG(p.avatarType||'boy', p.skinTone||'light', p.hairColor||HAIR_COLORS.brown, p.equipped||{}, 36);
      const grade = p.lastGrade ? `Grade ${p.lastGrade}` : '';
      return `<div class="player-chip" onclick="loginPlayer('${n}')">
        <div class="player-info">
          <div class="player-avatar-mini">${mini}</div>
          <div>
            <div class="player-name">${n}</div>
            <div class="player-meta">${grade} ‚Ä¢ Lvl ${p.stats?.highestLevel||1}</div>
          </div>
        </div>
        <div class="player-coins">ü™ô ${p.coins||0}</div>
      </div>`;
    }).join('');
  } else {
    listSection.style.display = 'none';
  }
}

function beginNewPlayer() {
  const name = document.getElementById('name-input').value.trim();
  if(!name){ alert('Please enter your name!'); return; }
  if(getPlayer(name)){ loginPlayer(name); return; }
  tempAvatarSetup.name = name;
  showScreen('avatar-type');
}

function loginPlayer(name) {
  loadCurrentPlayer(name);
  renderHub();
  showScreen('hub');
}

function switchPlayer() {
  currentPlayer = null;
  document.getElementById('name-input').value = '';
  renderWelcome();
  showScreen('welcome');
}

// =====================================================
//  AVATAR SETUP
// =====================================================
function selectAvatarType(type) {
  tempAvatarSetup.avatarType = type;
  document.querySelectorAll('.type-card').forEach(c=>c.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  setTimeout(()=>showScreen('skin-tone'),200);
  renderSkinToneScreen();
}

function renderSkinToneScreen() {
  const sg = document.getElementById('skin-grid');
  sg.innerHTML = Object.values(SKIN_TONES).map(st =>
    `<div class="skin-swatch ${tempAvatarSetup.skinTone===st.id?'selected':''}" style="background:${st.color}" onclick="selectSkin('${st.id}')" title="${st.name}"></div>`
  ).join('');
  const hg = document.getElementById('hair-color-grid');
  hg.innerHTML = Object.entries(HAIR_COLORS).map(([name,color]) =>
    `<div class="hair-swatch ${tempAvatarSetup.hairColor===color?'selected':''}" style="background:${color}" onclick="selectHairColor('${color}')" title="${name}"></div>`
  ).join('');
  updateSkinPreview();
}

function selectSkin(id) {
  tempAvatarSetup.skinTone = id;
  document.querySelectorAll('.skin-swatch').forEach((s,i)=>{
    const ids = Object.keys(SKIN_TONES);
    s.classList.toggle('selected', ids[i]===id);
  });
  updateSkinPreview();
}

function selectHairColor(color) {
  tempAvatarSetup.hairColor = color;
  document.querySelectorAll('.hair-swatch').forEach(s=>{
    s.classList.toggle('selected', s.style.background===color || s.style.background===`rgb(${hexToRgb(color)})`);
  });
  updateSkinPreview();
}

function hexToRgb(hex) {
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return `${r}, ${g}, ${b}`;
}

function updateSkinPreview() {
  const preview = document.getElementById('skin-preview');
  preview.innerHTML = generateAvatarSVG(tempAvatarSetup.avatarType, tempAvatarSetup.skinTone, tempAvatarSetup.hairColor, {}, 100);
}

function finishAvatarSetup() {
  const p = createPlayer(tempAvatarSetup.name, tempAvatarSetup.avatarType, tempAvatarSetup.skinTone, tempAvatarSetup.hairColor);
  loadCurrentPlayer(tempAvatarSetup.name);
  renderHub();
  showScreen('hub');
}

// =====================================================
//  HUB
// =====================================================
function renderHub() {
  if(!currentPlayer) return;
  const p = getPlayer(currentPlayer.name);
  currentPlayer = p;
  document.getElementById('hub-name').textContent = p.name;
  document.getElementById('hub-coins').textContent = p.coins || 0;
  document.getElementById('hub-grade-display').textContent = p.lastGrade ? `Last played: Grade ${p.lastGrade}` : 'Ready to play!';
  document.getElementById('hub-best-level').textContent = `Level ${p.stats?.highestLevel || 1}`;
  document.getElementById('hub-correct').textContent = p.stats?.totalCorrect || 0;
  const acc = p.stats?.totalAttempted > 0 ? Math.round(p.stats.totalCorrect/p.stats.totalAttempted*100)+'%' : '‚Äî';
  document.getElementById('hub-accuracy').textContent = acc;
  document.getElementById('hub-goats').textContent = `üêê ${p.stats?.goatCount || 0}`;
  const disp = document.getElementById('hub-avatar-display');
  disp.innerHTML = generateAvatarSVG(p.avatarType||'boy', p.skinTone||'light', p.hairColor||HAIR_COLORS.brown, p.equipped||{}, 100);
}

// =====================================================
//  PLAY FLOW
// =====================================================
function startPlayFlow() { showScreen('subject'); }

function selectSubject(s) {
  state.subject = s;
  if(s === 'spelling') showScreen('voice');
  else showScreen('grade');
  document.getElementById('grade-title').textContent = s === 'math' ? 'üìê Math ‚Äî Choose Grade' : 'üìñ Spelling ‚Äî Choose Grade';
}

function goBackFromGrade() {
  showScreen(state.subject === 'spelling' ? 'voice' : 'subject');
}

// ---- VOICE ----
let selectedVoiceType = 'woman-us';
function pickVoice(type) {
  selectedVoiceType = type;
  document.querySelectorAll('.voice-card').forEach(c=>c.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  document.getElementById('confirm-voice-btn').style.display = 'inline-flex';
  if('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(`Hi ${state.playerName||'there'}! Ready to spell some words?`);
    applyVoiceSettings(u, type);
    window.speechSynthesis.speak(u);
  }
}

function applyVoiceSettings(u, type) {
  u.rate=0.72; u.pitch=1.0; u.volume=1.0;
  if('speechSynthesis' in window) {
    const voices = window.speechSynthesis.getVoices();
    let voice = null;
    if(type==='woman-us') voice = voices.find(v=>v.lang.startsWith('en-US')&&v.name.toLowerCase().includes('female'))||voices.find(v=>v.lang.startsWith('en-US')&&!v.name.toLowerCase().includes('male'))||voices.find(v=>v.lang.startsWith('en-US'));
    else if(type==='man-us') voice = voices.find(v=>v.lang.startsWith('en-US')&&v.name.toLowerCase().includes('male'))||voices.find(v=>v.lang.startsWith('en-US'));
    else if(type==='woman-gb') voice = voices.find(v=>v.lang.startsWith('en-GB')&&!v.name.toLowerCase().includes('male'))||voices.find(v=>v.lang.startsWith('en-GB'));
    else if(type==='man-gb') voice = voices.find(v=>v.lang.startsWith('en-GB')&&v.name.toLowerCase().includes('male'))||voices.find(v=>v.lang.startsWith('en-GB'));
    if(voice) u.voice = voice;
  }
}

function confirmVoice() {
  state.voiceType = selectedVoiceType;
  showScreen('grade');
}

// ---- GAME ----
function startGame(grade) {
  state.grade = grade;
  state.difficulty = 1;
  state.streak = 0;
  state.consecutiveCorrect = 0;
  state.consecutiveWrong = 0;
  state.totalCorrect = 0;
  state.totalAttempted = 0;
  state.usedWords = {};
  const p = getPlayer(currentPlayer.name);
  if(p) {
    updatePlayer(currentPlayer.name, {lastGrade: grade});
  }
  generateProblem();
  showScreen('play');
  updatePlayUI();
  setTimeout(()=>document.getElementById('answer-input').focus(),300);
}

function generateProblem() {
  if(state.subject === 'math') {
    state.problem = generateMathProblem(state.grade, state.difficulty);
  } else {
    const word = pickSpellingWord(state.grade, state.difficulty);
    state.problem = {question: word, answer: word};
  }
  document.getElementById('answer-input').value = '';
  const fb = document.getElementById('feedback'); fb.style.display='none';
  const ht = document.getElementById('hint-text'); ht.style.display='none';
  updatePlayUI();
  if(state.subject === 'spelling') setTimeout(()=>speakWord(), 400);
  setTimeout(()=>document.getElementById('answer-input').focus(), 100);
}

function pickSpellingWord(grade, diff) {
  const bank = WORDS[grade]?.[diff] || WORDS[2][1];
  const key = `${grade}_${diff}`;
  if(!state.usedWords[key]) state.usedWords[key] = [];
  let available = bank.filter(w=>!state.usedWords[key].includes(w));
  if(available.length === 0) { state.usedWords[key]=[]; available=[...bank]; }
  const word = available[Math.floor(Math.random()*available.length)];
  state.usedWords[key].push(word);
  return word;
}

function speakWord() {
  if(!state.problem||state.subject!=='spelling'||!('speechSynthesis' in window)) return;
  window.speechSynthesis.cancel();
  const word = state.problem.answer;
  const u = new SpeechSynthesisUtterance(word);
  applyVoiceSettings(u, state.voiceType);
  window.speechSynthesis.speak(u);
}

function repeatWord() { speakWord(); }

function updatePlayUI() {
  document.getElementById('badge-subject').textContent = state.subject==='math'?'üî¢ Math':'üìù Spelling';
  document.getElementById('badge-grade').textContent = `Grade ${state.grade}`;
  document.getElementById('badge-level').textContent = `Level ${state.difficulty}`;
  const sb = document.getElementById('badge-streak');
  if(state.streak>=3){ sb.style.display='inline-block'; sb.textContent=`üî• ${state.streak}`; }
  else { sb.style.display='none'; }
  const prog = Math.min((state.consecutiveCorrect/5)*100, 100);
  document.getElementById('progress-fill').style.width = prog+'%';
  const p = getPlayer(currentPlayer.name);
  document.getElementById('play-coins').textContent = p?.coins || 0;
  if(state.subject==='math'){
    document.getElementById('question-label').textContent = `Solve this:`;
    document.getElementById('question-text').textContent = state.problem?.question || '';
    document.getElementById('question-sub').textContent = '';
    document.getElementById('repeat-btn').style.display='none';
  } else {
    document.getElementById('question-label').textContent = `Spell this word:`;
    document.getElementById('question-text').textContent = `üîä Listen!`;
    document.getElementById('question-sub').textContent = `Press üîä Repeat to hear it again`;
    document.getElementById('repeat-btn').style.display='inline-flex';
  }
}

function checkAnswer() {
  const input = document.getElementById('answer-input').value.trim();
  if(!input || !state.problem) return;
  state.totalAttempted++;
  const isCorrect = input.toLowerCase() === state.problem.answer.toString().toLowerCase();
  const fb = document.getElementById('feedback'); fb.style.display='block';
  if(isCorrect) {
    state.streak++;
    state.consecutiveCorrect++;
    state.consecutiveWrong = 0;
    state.totalCorrect++;
    // Earn coins
    const baseCoins = state.difficulty * 5;
    const streakBonus = state.streak >= 5 ? 5 : state.streak >= 3 ? 2 : 0;
    const earned = baseCoins + streakBonus;
    const newTotal = addCoins(currentPlayer.name, earned);
    document.getElementById('play-coins').textContent = newTotal;
    showCoinPopup(earned);
    // Update grade stats
    const players = getPlayers();
    const p = players[currentPlayer.name];
    if(p) {
      p.stats.totalCorrect = (p.stats.totalCorrect||0)+1;
      p.stats.totalAttempted = (p.stats.totalAttempted||0)+1;
      if(!p.stats.gradeStats) p.stats.gradeStats = {};
      if(!p.stats.gradeStats[state.grade]) p.stats.gradeStats[state.grade]={correct:0,attempted:0};
      p.stats.gradeStats[state.grade].correct++;
      p.stats.gradeStats[state.grade].attempted++;
      savePlayers(players);
    }
    fb.className='feedback correct';
    fb.innerHTML=`‚úÖ Correct! +${earned} ü™ô${streakBonus>0?` (${state.streak}üî• streak bonus!)`:''}`;
    // Level up check
    if(state.consecutiveCorrect >= 5) {
      state.consecutiveCorrect = 0;
      state.difficulty = Math.min(state.difficulty+1, 5);
      if(state.difficulty > 5 || (state.difficulty===5 && state.consecutiveCorrect>=5)) {
        // GOAT!
      } else {
        const lvlBonus = 25;
        addCoins(currentPlayer.name, lvlBonus);
        fb.innerHTML += ` üéâ LEVEL UP! +${lvlBonus} ü™ô`;
        updatePlayerHighestLevel();
        // Check for GOAT
        if(state.difficulty > 5) {
          setTimeout(()=>triggerGoat(), 600);
          return;
        }
      }
    }
    // Check if was already at max level
    if(state.difficulty >= 6) { setTimeout(()=>triggerGoat(),600); return; }
    setTimeout(()=>generateProblem(), 1200);
  } else {
    state.streak = 0;
    state.consecutiveWrong++;
    state.consecutiveCorrect = Math.max(0, state.consecutiveCorrect-1);
    // Update attempted
    const players = getPlayers();
    const p = players[currentPlayer.name];
    if(p) {
      p.stats.totalAttempted=(p.stats.totalAttempted||0)+1;
      if(!p.stats.gradeStats) p.stats.gradeStats={};
      if(!p.stats.gradeStats[state.grade]) p.stats.gradeStats[state.grade]={correct:0,attempted:0};
      p.stats.gradeStats[state.grade].attempted++;
      savePlayers(players);
    }
    fb.className='feedback wrong';
    fb.textContent = state.subject==='spelling' ? `‚ùå Not quite! Listen again carefully.` : `‚ùå Not quite! Try again.`;
    if(state.consecutiveWrong>=2 && state.subject==='spelling') {
      const ht=document.getElementById('hint-text');
      ht.style.display='block';
      ht.textContent=`Hint: ${state.problem.answer.slice(0,2)}${'_'.repeat(state.problem.answer.length-2)}`;
    }
    if(state.difficulty>1 && state.consecutiveWrong>=3){ state.consecutiveWrong=0; state.difficulty--; }
    if(state.subject==='spelling') setTimeout(()=>speakWord(),800);
  }
  updatePlayUI();
}

function updatePlayerHighestLevel() {
  const players = getPlayers();
  const p = players[currentPlayer.name];
  if(p && state.difficulty > (p.stats.highestLevel||1)) {
    p.stats.highestLevel = state.difficulty;
    savePlayers(players);
  }
}

function showCoinPopup(amount) {
  const popup = document.createElement('div');
  popup.className = 'coin-popup';
  popup.textContent = `+${amount} ü™ô`;
  popup.style.left = `${40+Math.random()*40}%`;
  popup.style.top = `${30+Math.random()*20}%`;
  document.body.appendChild(popup);
  setTimeout(()=>popup.remove(), 1600);
}

function triggerGoat() {
  // Award GOAT bonus
  const goatBonus = 100;
  const newTotal = addCoins(currentPlayer.name, goatBonus);
  const players = getPlayers();
  const p = players[currentPlayer.name];
  if(p){
    p.stats.goatCount=(p.stats.goatCount||0)+1;
    savePlayers(players);
    currentPlayer = p;
  }
  document.getElementById('goat-title').textContent = `${currentPlayer.name} is the GOAT! üêê`;
  document.getElementById('goat-msg').textContent = `Baaaaa! You are the Greatest of All Time!`;
  document.getElementById('goat-coins').textContent = `+${goatBonus} ü™ô ‚Äî Total: ${newTotal} ü™ô`;
  const gad = document.getElementById('goat-avatar-display');
  const p2 = getPlayer(currentPlayer.name);
  gad.innerHTML = generateAvatarSVG(p2.avatarType||'boy', p2.skinTone||'light', p2.hairColor||HAIR_COLORS.brown, p2.equipped||{}, 120);
  spawnConfetti();
  playGoatSound();
  showScreen('goat');
}

function keepPlaying() {
  state.difficulty = 1;
  state.consecutiveCorrect = 0;
  state.consecutiveWrong = 0;
  generateProblem();
  showScreen('play');
}

function goToHub() {
  renderHub();
  showScreen('hub');
}

// =====================================================
//  GOAT SOUND
// =====================================================
function playGoatSound() {
  try {
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    function osc(freq,start,dur,type='sine',vol=0.3){
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.type=type; o.frequency.setValueAtTime(freq,ctx.currentTime+start);
      o.frequency.exponentialRampToValueAtTime(freq*0.7,ctx.currentTime+start+dur*0.5);
      g.gain.setValueAtTime(vol,ctx.currentTime+start);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+start+dur);
      o.connect(g); g.connect(ctx.destination);
      o.start(ctx.currentTime+start); o.stop(ctx.currentTime+start+dur);
    }
    osc(350,0,0.4,'sawtooth',0.2); osc(280,0,0.4,'sawtooth',0.15);
    osc(400,0.1,0.3,'square',0.1); osc(200,0.4,0.5,'sawtooth',0.2);
    osc(250,0.4,0.5,'sawtooth',0.15); osc(180,0.8,0.4,'sine',0.2);
  } catch(e){}
}

// =====================================================
//  CONFETTI
// =====================================================
function spawnConfetti() {
  const c=document.getElementById('confetti-container'); c.innerHTML='';
  const colors=['#FFD700','#FF6B6B','#4ECDC4','#A78BFA','#F97316','#06D6A0','#FFE66D'];
  let html='';
  for(let i=0;i<60;i++){
    const color=colors[Math.floor(Math.random()*colors.length)];
    const size=6+Math.random()*10, left=Math.random()*100;
    const dur=1.5+Math.random()*2, delay=Math.random()*1;
    const radius=Math.random()>0.5?'50%':'2px';
    const rot=Math.random()*360;
    html+=`<div style="position:absolute;left:${left}%;width:${size}px;height:${size}px;background:${color};border-radius:${radius};animation:confettiFall ${dur}s ease-out ${delay}s forwards;transform:rotate(${rot}deg)"></div>`;
  }
  c.innerHTML=html;
  setTimeout(()=>c.innerHTML='',4000);
}

// =====================================================
//  SHOP
// =====================================================
let currentShopCategory = 'hair';

function renderShop() {
  const p = getPlayer(currentPlayer.name);
  document.getElementById('shop-coins').textContent = p.coins||0;
  // Tabs
  const tabs = document.getElementById('shop-tabs');
  tabs.innerHTML = Object.entries(SHOP_ITEMS).map(([cat,data])=>
    `<button class="shop-tab ${cat===currentShopCategory?'active':''}" onclick="switchShopCategory('${cat}')">${data.label}</button>`
  ).join('');
  renderShopItems();
}

function switchShopCategory(cat) {
  currentShopCategory = cat;
  renderShop();
}

function renderShopItems() {
  const p = getPlayer(currentPlayer.name);
  const catData = SHOP_ITEMS[currentShopCategory];
  const grid = document.getElementById('shop-grid');
  grid.innerHTML = Object.entries(catData.items).map(([id,item])=>{
    const owned = (p.ownedItems||[]).includes(id);
    const equipped = p.equipped?.[currentShopCategory] === id;
    const canAfford = p.coins >= item.price;
    const isGoat = item.isGoat;
    let badge = equipped ? `<div class="equipped-badge">Equipped</div>` : owned ? `<div class="owned-badge">Owned</div>` : '';
    let lock = !owned && !canAfford ? `<div class="lock-overlay">üîí</div>` : '';
    let goatStar = isGoat ? `<div class="goat-star">üêê</div>` : '';
    let cls = `shop-item${owned?' owned':''}${equipped?' equipped':''}${isGoat?' goat-item':''}${!owned&&!canAfford?' cant-afford':''}`;
    // Preview SVG
    let previewSVG = getItemPreviewSVG(id, currentShopCategory, p);
    return `<div class="${cls}" onclick="shopItemClick('${id}','${currentShopCategory}')">
      ${badge}${lock}${goatStar}
      <div class="item-preview">${previewSVG}</div>
      <div class="item-name">${item.name}</div>
      <div class="item-price ${owned?'free':''}">${owned ? (equipped?'‚úì Equipped':'‚úì Owned') : `ü™ô ${item.price}`}</div>
    </div>`;
  }).join('');
}

function getItemPreviewSVG(itemId, cat, p) {
  // Show a mini avatar preview with just this item applied
  const previewEquipped = {};
  if(cat && itemId) previewEquipped[cat] = itemId;
  return generateAvatarSVG(p.avatarType||'boy', p.skinTone||'light', p.hairColor||HAIR_COLORS.brown, previewEquipped, 70);
}

function shopItemClick(itemId, cat) {
  const p = getPlayer(currentPlayer.name);
  const item = SHOP_ITEMS[cat]?.items[itemId];
  if(!item) return;
  const owned = (p.ownedItems||[]).includes(itemId);
  if(owned) {
    // Equip/unequip
    const players = getPlayers();
    const pl = players[currentPlayer.name];
    if(!pl.equipped) pl.equipped = {};
    if(pl.equipped[cat] === itemId) {
      pl.equipped[cat] = null; // unequip
    } else {
      pl.equipped[cat] = itemId;
    }
    savePlayers(players);
    currentPlayer = pl;
    renderShop();
    renderHub();
  } else {
    // Buy
    if(p.coins < item.price){
      alert(`You need ${item.price - p.coins} more coins! Keep playing to earn them.`);
      return;
    }
    if(confirm(`Buy "${item.name}" for ü™ô ${item.price}?`)) {
      const players = getPlayers();
      const pl = players[currentPlayer.name];
      pl.coins -= item.price;
      if(!pl.ownedItems) pl.ownedItems=[];
      pl.ownedItems.push(itemId);
      if(!pl.equipped) pl.equipped={};
      pl.equipped[cat] = itemId; // auto-equip on purchase
      savePlayers(players);
      currentPlayer = pl;
      renderShop();
      renderHub();
    }
  }
}

// =====================================================
//  AVATAR BUILDER
// =====================================================
function renderAvatarBuilder() {
  const p = getPlayer(currentPlayer.name);
  builderEquipped = JSON.parse(JSON.stringify(p.equipped||{}));
  updateBuilderPreview();
  const controls = document.getElementById('builder-controls');
  let html = '';
  // Skin tone
  html += `<div class="builder-category">Skin Tone</div>
    <div class="skin-builder-row">
      ${Object.values(SKIN_TONES).map(st=>
        `<div class="skin-dot ${p.skinTone===st.id?'active':''}" style="background:${st.color}" onclick="builderSetSkin('${st.id}')" title="${st.name}"></div>`
      ).join('')}
    </div>`;
  // Hair color
  html += `<div class="builder-category">Hair Color</div>
    <div class="skin-builder-row">
      ${Object.entries(HAIR_COLORS).map(([name,color])=>
        `<div class="hair-dot ${p.hairColor===color?'active':''}" style="background:${color}" onclick="builderSetHair('${color}')" title="${name}"></div>`
      ).join('')}
    </div>`;
  // Each equippable category
  for(const [cat, catData] of Object.entries(SHOP_ITEMS)) {
    html += `<div class="builder-category">${catData.label}</div><div class="builder-items">`;
    html += `<div class="builder-chip ${!builderEquipped[cat]?'active':''}" onclick="builderEquip('${cat}',null)">None</div>`;
    for(const [id,item] of Object.entries(catData.items)){
      const owned = (p.ownedItems||[]).includes(id);
      const active = builderEquipped[cat]===id;
      html += `<div class="builder-chip ${active?'active':''} ${!owned?'locked':''}" onclick="${owned?`builderEquip('${cat}','${id}')`:'void(0)'}">${item.emoji} ${item.name}${!owned?' üîí':''}</div>`;
    }
    html += '</div>';
  }
  controls.innerHTML = html;
}

function builderSetSkin(skinId) {
  const players = getPlayers();
  players[currentPlayer.name].skinTone = skinId;
  savePlayers(players);
  currentPlayer = players[currentPlayer.name];
  renderAvatarBuilder();
}

function builderSetHair(color) {
  const players = getPlayers();
  players[currentPlayer.name].hairColor = color;
  savePlayers(players);
  currentPlayer = players[currentPlayer.name];
  renderAvatarBuilder();
}

function builderEquip(cat, itemId) {
  builderEquipped[cat] = itemId;
  updateBuilderPreview();
  // update active chips
  document.querySelectorAll('.builder-items .builder-chip').forEach(c=>{
    // rough active update
  });
  renderAvatarBuilder();
}

function updateBuilderPreview() {
  const p = getPlayer(currentPlayer.name);
  const preview = document.getElementById('builder-avatar-preview');
  preview.innerHTML = generateAvatarSVG(p.avatarType||'boy', p.skinTone||'light', p.hairColor||HAIR_COLORS.brown, builderEquipped||{}, 140);
}

function saveAvatar() {
  const players = getPlayers();
  players[currentPlayer.name].equipped = {...builderEquipped};
  savePlayers(players);
  currentPlayer = players[currentPlayer.name];
  renderHub();
  showScreen('hub');
}

// =====================================================
//  STATS
// =====================================================
function renderStats() {
  const p = getPlayer(currentPlayer.name);
  const stats = p.stats || {};
  const acc = stats.totalAttempted>0 ? Math.round(stats.totalCorrect/stats.totalAttempted*100) : 0;
  const gs = stats.gradeStats || {};
  let gradeRows = [2,3,4,5].map(g=>{
    const d = gs[g]||{correct:0,attempted:0};
    const a = d.attempted>0?Math.round(d.correct/d.attempted*100):0;
    return d.attempted > 0 ? `<tr>
      <td>Grade ${g}</td>
      <td>${d.correct}/${d.attempted}</td>
      <td>
        <div>${a}%</div>
        <div class="accuracy-bar"><div class="accuracy-fill" style="width:${a}%"></div></div>
      </td>
    </tr>` : '';
  }).filter(Boolean).join('');

  document.getElementById('stats-content').innerHTML = `
    <div class="stats-grid">
      <div class="stat-card"><div class="s-value">${stats.totalCorrect||0}</div><div class="s-label">Total Correct</div></div>
      <div class="stat-card"><div class="s-value">${acc}%</div><div class="s-label">Accuracy</div></div>
      <div class="stat-card"><div class="s-value">Lvl ${stats.highestLevel||1}</div><div class="s-label">Best Level</div></div>
      <div class="stat-card"><div class="s-value">üêê ${stats.goatCount||0}</div><div class="s-label">GOAT Times</div></div>
    </div>
    <div class="card" style="margin-top:16px">
      <div style="font-weight:800;margin-bottom:12px">Performance by Grade</div>
      ${gradeRows ? `<table class="grade-stats-table">
        <thead><tr><th>Grade</th><th>Correct/Played</th><th>Accuracy</th></tr></thead>
        <tbody>${gradeRows}</tbody>
      </table>` : '<p style="color:var(--muted);font-size:.9rem">No games played yet! Start playing to see your stats.</p>'}
    </div>
    <div class="card" style="margin-top:12px">
      <div style="font-weight:800;margin-bottom:12px">Coin Wallet ü™ô</div>
      <div style="font-size:2rem;font-weight:900;color:var(--coin)">${p.coins||0} coins</div>
      <div style="color:var(--muted);font-size:.85rem;margin-top:4px">Earn by answering correctly ‚Äî streaks pay more!</div>
    </div>`;
}

// =====================================================
//  EVENT WIRING
// =====================================================
document.getElementById('answer-input').addEventListener('keydown', e=>{
  if(e.key==='Enter') checkAnswer();
});
document.getElementById('name-input').addEventListener('keydown', e=>{
  if(e.key==='Enter') beginNewPlayer();
});

// Wire screen shows that need render
const origShow = showScreen;
window.showScreen = function(name) {
  origShow(name);
  if(name==='shop') renderShop();
  if(name==='avatar-builder') renderAvatarBuilder();
  if(name==='stats') renderStats();
  if(name==='hub') renderHub();
  if(name==='welcome') renderWelcome();
};

// Init
if('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = ()=>speechSynthesis.getVoices();
  speechSynthesis.getVoices();
}

renderWelcome();
showScreen('welcome');
</script>
</body>
</html>
